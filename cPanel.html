<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>cPanel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Hind Siliguri', sans-serif; background: #f3f4f6; }
        .ql-editor { min-height: 300px; font-size: 16px; background: white; }
        .sidebar-item { transition: 0.2s; cursor: pointer; }
        .sidebar-item:hover, .sidebar-item.active { background: #1e293b; color: white; border-right: 4px solid #ef4444; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; display: none; place-items: center; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-gray-800">

<div id="loader" class="loading-overlay"><div class="animate-spin rounded-full h-12 w-12 border-b-4 border-red-600"></div></div>

<aside class="w-64 bg-slate-900 text-gray-400 flex flex-col shadow-2xl z-20">
    <div class="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-900 font-bold text-white text-xl tracking-wide">
        <i class="fas fa-newspaper mr-2 text-red-500"></i> cPanel
    </div>
    <nav class="flex-1 py-4 space-y-1">
        <div onclick="switchTab('dashboard')" class="sidebar-item active px-6 py-3 flex items-center gap-3"><i class="fas fa-tachometer-alt"></i> ড্যাশবোর্ড</div>
        <div onclick="switchTab('create')" class="sidebar-item px-6 py-3 flex items-center gap-3"><i class="fas fa-pen-nib"></i> নতুন নিউজ</div>
        <div onclick="switchTab('list')" class="sidebar-item px-6 py-3 flex items-center gap-3"><i class="fas fa-list"></i> নিউজ লিস্ট</div>
        <div onclick="switchTab('category')" class="sidebar-item px-6 py-3 flex items-center gap-3"><i class="fas fa-tags"></i> ক্যাটাগরি</div>
    </nav>
    <div class="p-4 border-t border-slate-800">
        <button onclick="logout()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded transition flex justify-center items-center gap-2">
            <i class="fas fa-sign-out-alt"></i> লগ আউট
        </button>
    </div>
</aside>

<main class="flex-1 flex flex-col h-full overflow-hidden relative">
    <header class="h-16 bg-white shadow-sm flex justify-between items-center px-8 z-10">
        <h2 id="page-title" class="text-xl font-bold text-gray-700">ড্যাশবোর্ড ওভারভিউ</h2>
        <div class="flex items-center gap-3">
            <span class="text-sm font-semibold bg-green-100 text-green-700 px-3 py-1 rounded-full">অ্যাডমিন অ্যাক্টিভ</span>
        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8" id="main-content">
        <!-- Dashboard View -->
        <div id="view-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-500">
                <div class="text-gray-500">মোট নিউজ</div>
                <div class="text-3xl font-bold" id="total-news">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                <div class="text-gray-500">মোট ক্যাটাগরি</div>
                <div class="text-3xl font-bold" id="total-cats">0</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow border-l-4 border-purple-500">
                <div class="text-gray-500">মোট ভিউ</div>
                <div class="text-3xl font-bold" id="total-views">0</div>
            </div>
        </div>

        <!-- Create/Edit News View -->
        <div id="view-create" class="hidden max-w-5xl mx-auto bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold" id="editor-title">নতুন নিউজ লিখুন</h3>
                <div class="flex gap-2">
                    <button onclick="resetForm()" class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-200 rounded">রিসেট</button>
                    <button onclick="togglePreview()" class="px-4 py-2 text-sm bg-indigo-100 text-indigo-700 hover:bg-indigo-200 rounded flex items-center gap-1"><i class="fas fa-eye"></i> প্রিভিউ</button>
                </div>
            </div>
            <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-4">
                    <input type="hidden" id="edit-id">
                    <div>
                        <label class="block font-medium mb-1 text-sm">শিরোনাম</label>
                        <input type="text" id="news-title" class="w-full border border-gray-300 p-3 rounded focus:border-blue-500 outline-none text-lg font-semibold" placeholder="আকর্ষণীয় শিরোনাম লিখুন...">
                    </div>
                    <div>
                        <label class="block font-medium mb-1 text-sm">বিস্তারিত সংবাদ</label>
                        <div id="editor-container"></div> 
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block font-medium mb-1 text-sm">ক্যাটাগরি</label>
                        <select id="news-cat" class="w-full border p-2 rounded bg-white focus:ring-2 focus:ring-blue-200 outline-none"></select>
                    </div>
                    <div>
                        <label class="block font-medium mb-1 text-sm">কভার ছবি</label>
                        <div class="border-2 border-dashed border-gray-300 p-4 rounded text-center hover:bg-gray-50 relative">
                            <input type="file" id="img-input" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="previewImage(this)">
                            <div id="img-preview-box" class="text-gray-400">
                                <i class="fas fa-cloud-upload-alt text-3xl mb-2"></i>
                                <p class="text-xs">ছবি আপলোড করতে ক্লিক করুন</p>
                            </div>
                            <img id="preview-img" class="hidden w-full h-40 object-cover rounded mt-2">
                        </div>
                    </div>
                    <div>
                        <label class="block font-medium mb-1 text-sm">ভিডিও লিংক (Youtube Embed)</label>
                        <input type="text" id="news-video" class="w-full border p-2 rounded text-sm" placeholder="https://www.youtube.com/embed/code">
                    </div>
                    <div>
                        <label class="block font-medium mb-1 text-sm">বিজ্ঞাপন / কাস্টম স্ক্রিপ্ট</label>
                        <textarea id="news-ad" class="w-full border p-2 rounded text-xs font-mono bg-gray-50" rows="4" placeholder="<script>...</script>"></textarea>
                    </div>
                    <button onclick="publishNews()" class="w-full bg-green-600 text-white py-3 rounded font-bold hover:bg-green-700 shadow-lg transform active:scale-95 transition">
                        <i class="fas fa-paper-plane mr-2"></i> প্রকাশ করুন
                    </button>
                </div>
            </div>
        </div>

        <!-- List View -->
        <div id="view-list" class="hidden bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 text-sm uppercase">
                            <th class="p-4 border-b">ছবি</th>
                            <th class="p-4 border-b">শিরোনাম</th>
                            <th class="p-4 border-b">ক্যাটাগরি</th>
                            <th class="p-4 border-b">তারিখ</th>
                            <th class="p-4 border-b text-right">অ্যাকশন</th>
                        </tr>
                    </thead>
                    <tbody id="news-table-body" class="text-sm divide-y"></tbody>
                </table>
            </div>
        </div>

        <!-- Category View -->
        <div id="view-category" class="hidden max-w-2xl mx-auto">
            <div class="bg-white p-6 rounded shadow mb-6 flex gap-4">
                <input type="text" id="new-cat-name" class="flex-1 border p-3 rounded" placeholder="নতুন ক্যাটাগরির নাম...">
                <button onclick="addCategory()" class="bg-blue-600 text-white px-6 rounded font-bold hover:bg-blue-700">যোগ করুন</button>
            </div>
            <div class="bg-white rounded shadow overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-100"><tr class="text-gray-600 text-sm"><th class="p-4">নাম</th><th class="p-4 text-right">অ্যাকশন</th></tr></thead>
                    <tbody id="cat-list-body" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Preview Modal -->
<div id="preview-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden overflow-y-auto">
    <div class="max-w-4xl mx-auto bg-white min-h-screen relative p-8">
        <button onclick="togglePreview()" class="fixed top-4 right-4 bg-red-600 text-white w-10 h-10 rounded-full z-50">✕</button>
        <div id="preview-content"></div>
    </div>
</div>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, deleteDoc, updateDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD_HBGuQSh_GzqrHqHbgdaoBikLZsK3Qqs",
        authDomain: "new-all-f99f7.firebaseapp.com",
        projectId: "new-all-f99f7",
        storageBucket: "new-all-f99f7.firebasestorage.app",
        messagingSenderId: "1069748173900",
        appId: "1:1069748173900:web:158d6336c0f4628133c8e9",
        measurementId: "G-V6DZ37WSBF"
    };

    const CLOUD_NAME = "dwgvvzbvn";
    const UPLOAD_PRESET = "storyapp";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Quill Setup
    var quill = new Quill('#editor-container', {
        theme: 'snow',
        placeholder: 'এখানে নিউজ লিখুন...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['link', 'image', 'video']
            ]
        }
    });

    // Auth Check
    onAuthStateChanged(auth, user => {
        if (!user) {
            // For demo simplicity, relying on firebase rules or external login page. 
            // In production, redirect to login page if not admin.
            console.log("No Admin User");
        }
    });
    window.logout = () => signOut(auth).then(() => window.location.href = 'index.html');

    // UI Logic
    let currentImageURL = "";
    
    window.switchTab = (tab) => {
        document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
        document.getElementById(`view-${tab}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active', 'bg-slate-800', 'border-r-4', 'border-red-500'));
        event.currentTarget.classList.add('active', 'bg-slate-800', 'border-r-4', 'border-red-500');
        
        const titles = { dashboard: 'ড্যাশবোর্ড', create: 'নিউজ তৈরি', list: 'নিউজ তালিকা', category: 'ক্যাটাগরি ম্যানেজমেন্ট' };
        document.getElementById('page-title').innerText = titles[tab];
        
        if(tab === 'list') loadNewsList();
        if(tab === 'dashboard') loadStats();
    };

    window.previewImage = (input) => {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').classList.remove('hidden');
                document.getElementById('img-preview-box').classList.add('hidden');
            }
            reader.readAsDataURL(input.files[0]);
        }
    };

    // CRUD Operations
    async function loadCategories() {
        const sel = document.getElementById('news-cat');
        const list = document.getElementById('cat-list-body');
        sel.innerHTML = '<option value="">নির্বাচন করুন...</option>';
        list.innerHTML = '';
        
        const snap = await getDocs(collection(db, "categories"));
        snap.forEach(d => {
            sel.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`;
            list.innerHTML += `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-medium">${d.data().name}</td>
                    <td class="p-4 text-right"><button onclick="deleteCat('${d.id}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>
                </tr>
            `;
        });
        document.getElementById('total-cats').innerText = snap.size;
    }

    window.addCategory = async () => {
        const name = document.getElementById('new-cat-name').value;
        if(name) {
            await addDoc(collection(db, "categories"), {name});
            document.getElementById('new-cat-name').value = '';
            loadCategories();
        }
    };

    window.deleteCat = async (id) => {
        if(confirm('মুছে ফেলবেন?')) {
            await deleteDoc(doc(db, "categories", id));
            loadCategories();
        }
    };

    window.publishNews = async () => {
        document.getElementById('loader').style.display = 'grid';
        
        const id = document.getElementById('edit-id').value;
        const title = document.getElementById('news-title').value;
        const cat = document.getElementById('news-cat').value;
        const content = quill.root.innerHTML;
        const video = document.getElementById('news-video').value;
        const ad = document.getElementById('news-ad').value;
        const file = document.getElementById('img-input').files[0];

        try {
            if(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method: 'POST', body: formData});
                const data = await res.json();
                currentImageURL = data.secure_url;
            }

            const payload = {
                title, category: cat, content, video, adCode: ad, 
                image: currentImageURL, 
                timestamp: serverTimestamp() // Always update timestamp or keep original logic if needed
            };

            if(id) {
                await updateDoc(doc(db, "news", id), payload);
                alert('নিউজ আপডেট হয়েছে!');
            } else {
                await addDoc(collection(db, "news"), { ...payload, views: 0 });
                alert('নিউজ প্রকাশিত হয়েছে!');
            }
            
            resetForm();
            switchTab('list');

        } catch(e) {
            alert('Error: ' + e.message);
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    };

    async function loadNewsList() {
        const tbody = document.getElementById('news-table-body');
        tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center">লোড হচ্ছে...</td></tr>';
        
        const q = query(collection(db, "news"), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        
        tbody.innerHTML = '';
        snap.forEach(d => {
            const n = d.data();
            tbody.innerHTML += `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="p-4"><img src="${n.image}" class="w-12 h-12 object-cover rounded"></td>
                    <td class="p-4 font-bold text-gray-700 max-w-xs truncate">${n.title}</td>
                    <td class="p-4"><span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">${n.category}</span></td>
                    <td class="p-4 text-gray-500">${n.timestamp ? new Date(n.timestamp.toDate()).toLocaleDateString('bn-BD') : ''}</td>
                    <td class="p-4 text-right space-x-2">
                        <button onclick='editNews(${JSON.stringify({id: d.id, ...n})})' class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteNews('${d.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
        document.getElementById('total-news').innerText = snap.size;
    }

    window.editNews = (n) => {
        document.getElementById('edit-id').value = n.id;
        document.getElementById('news-title').value = n.title;
        document.getElementById('news-cat').value = n.category;
        document.getElementById('news-video').value = n.video || '';
        document.getElementById('news-ad').value = n.adCode || '';
        quill.root.innerHTML = n.content;
        currentImageURL = n.image;
        
        document.getElementById('preview-img').src = n.image;
        document.getElementById('preview-img').classList.remove('hidden');
        document.getElementById('img-preview-box').classList.add('hidden');
        document.getElementById('editor-title').innerText = "নিউজ এডিট করুন";
        
        switchTab('create');
    };

    window.deleteNews = async (id) => {
        if(confirm('স্থায়ীভাবে ডিলিট করতে চান?')) {
            await deleteDoc(doc(db, "news", id));
            loadNewsList();
        }
    };

    window.resetForm = () => {
        document.getElementById('edit-id').value = '';
        document.getElementById('news-title').value = '';
        document.getElementById('news-video').value = '';
        document.getElementById('news-ad').value = '';
        document.getElementById('img-input').value = '';
        document.getElementById('preview-img').classList.add('hidden');
        document.getElementById('img-preview-box').classList.remove('hidden');
        quill.root.innerHTML = '';
        currentImageURL = '';
        document.getElementById('editor-title').innerText = "নতুন নিউজ লিখুন";
    };

    window.togglePreview = () => {
        const modal = document.getElementById('preview-modal');
        if(modal.classList.contains('hidden')) {
            const content = `
                <h1 class="text-4xl font-bold mb-4">${document.getElementById('news-title').value}</h1>
                <img src="${document.getElementById('preview-img').src}" class="w-full max-h-[500px] object-cover mb-6 rounded">
                <div class="prose max-w-none text-lg">${quill.root.innerHTML}</div>
            `;
            document.getElementById('preview-content').innerHTML = content;
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    };

    async function loadStats() {
        const nS = await getDocs(collection(db, "news"));
        const cS = await getDocs(collection(db, "categories"));
        let views = 0;
        nS.forEach(d => views += (d.data().views || 0));
        
        document.getElementById('total-news').innerText = nS.size;
        document.getElementById('total-cats').innerText = cS.size;
        document.getElementById('total-views').innerText = views;
    }

    loadCategories();
    loadStats();
    
    // Make editNews accessible globally because of JSON.stringify inline quirk
    window.editNews = function(data) {
        // Re-attach data from HTML attribute string
        if(typeof data === 'string') data = JSON.parse(data);
        document.getElementById('edit-id').value = data.id;
        document.getElementById('news-title').value = data.title;
        document.getElementById('news-cat').value = data.category;
        document.getElementById('news-video').value = data.video || '';
        document.getElementById('news-ad').value = data.adCode || '';
        quill.root.innerHTML = data.content;
        currentImageURL = data.image;
        document.getElementById('preview-img').src = data.image;
        document.getElementById('preview-img').classList.remove('hidden');
        document.getElementById('img-preview-box').classList.add('hidden');
        document.getElementById('editor-title').innerText = "নিউজ এডিট করুন (ID: "+data.id+")";
        switchTab('create');
    }
</script>
</body>
</html>
