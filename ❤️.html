<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Premium Live Stream</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp">
<style>
    /* --- Base Styles --- */
    * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    html, body {
        background: #000;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    
    /* --- Video Container --- */
    .shaka-video-container {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background: #000; /* Ensures black background during switch */
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    /* Video Element: Force black background to stop white flash */
    video#video {
        width: 100%;
        height: 100%;
        background: #000; 
        object-fit: contain;
    }

    /* --- Custom Loader (Fix: Visible above everything) --- */
    #custom-loader {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 2000; /* High z-index to stay on top */
        display: none;
        pointer-events: none;
    }
    .loader-ring {
        width: 60px;
        height: 60px;
    }
    .loader-ring:after {
        content: " ";
        display: block;
        width: 48px;
        height: 48px;
        margin: 6px;
        border-radius: 50%;
        border: 5px solid #fff;
        border-color: #fff transparent #fff transparent;
        animation: loader-spin 1.2s linear infinite;
        box-shadow: 0 0 15px rgba(255,255,255,0.3);
    }
    @keyframes loader-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- Logo Styles (Fix: Size increased & Positioning) --- */
    #myLogo {
        width: 110px; /* লোগো একটু বড় করা হয়েছে */
        max-width: 20vw;
        height: auto;
        position: absolute;
        left: 20px;
        top: 20px;
        z-index: 15; /* লোডারের নিচে কিন্তু ভিডিওর উপরে */
        display: none;
        object-fit: contain;
        pointer-events: none;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
    }

    /* --- Channel Switcher (Top Right) --- */
    #channelSwitcherContainer {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 100;
    }
    
    #currentChannelBtn {
        background: rgba(20, 20, 20, 0.6);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    
    #channelList {
        list-style: none;
        padding: 5px;
        margin: 8px 0 0;
        background: rgba(20, 20, 20, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 8px;
        position: absolute;
        right: 0;
        min-width: 180px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
        flex-direction: column;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
    }
    #channelList.show { display: flex; }
    
    #channelList li {
        padding: 10px 14px;
        cursor: pointer;
        color: #ccc;
        font-size: 13px;
        border-radius: 4px;
        transition: background 0.2s;
        margin-bottom: 2px;
    }
    #channelList li:hover {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
    }
    #channelList li.active {
        background: rgba(229, 9, 20, 0.2);
        color: #e50914;
        font-weight: 700;
        border: 1px solid rgba(229, 9, 20, 0.3);
    }

    /* --- Live Indicator (Fix: Aligned with controls) --- */
    .live-indicator {
        position: absolute;
        bottom: 10px; /* নিচে নামানো হয়েছে কন্ট্রোল বারের সাথে মিল রাখতে */
        left: 15px;
        display: flex;
        align-items: center;
        font-weight: 700;
        color: #fff;
        font-size: 14px;
        z-index: 10;
        text-shadow: 0 1px 3px rgba(0,0,0,0.8);
        pointer-events: none;
    }
    .live-dot {
        width: 8px;
        height: 8px;
        background-color: #ff0000;
        border-radius: 50%;
        margin-right: 8px;
        box-shadow: 0 0 8px rgba(255, 0, 0, 0.8);
        animation: live-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes live-pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(0.8); }
    }

    /* --- Overlay (Firebase) --- */
    #overlay-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #000;
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    #overlay-video, #overlay-image {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    /* --- UI Fade Logic --- */
    .ui-element {
        opacity: 1;
        transition: opacity 0.5s ease-in-out;
        pointer-events: auto;
    }
    .ui-element.fade-out {
        opacity: 0;
        pointer-events: none;
    }

    /* --- Shaka Player Overrides (Fix: Hide Fullscreen Icon & Giant Play Button) --- */
    .shaka-seek-bar-container, .shaka-range-container, .shaka-current-time { display: none !important; }
    .shaka-overflow-menu-button { opacity: 0 !important; pointer-events: none !important; }
    .shaka-bottom-controls { padding-bottom: 5px; margin-left: 70px; /* লাইভ লেখার জন্য জায়গা */ }
    .shaka-controls-button-panel { background: transparent !important; }
    .shaka-spinner-container { display: none !important; } 
    
    /* Hide the Fullscreen button visually but keep structure if needed */
    .shaka-fullscreen-button { 
        opacity: 0 !important; 
        pointer-events: none !important; 
        width: 0 !important;
        margin: 0 !important;
    }

    /* Hide the Giant Play Button so custom loader is visible */
    .shaka-giant-play-button-container {
        display: none !important;
    }
</style>
</head>
<body>

<div class="shaka-video-container" data-shaka-player-container>
    <video autoplay playsinline id="video" poster="https://res.cloudinary.com/dwgvvzbvn/image/upload/v1764246852/e8saiyn9cbebon6tnf5j.jpg"></video>
    
    <!-- Custom Loader (Now clearly visible) -->
    <div id="custom-loader">
        <div class="loader-ring"></div>
    </div>

    <!-- Logo -->
    <img id="myLogo" src="tiolive.png" alt="Logo">

    <!-- UI Elements -->
    <div class="live-indicator ui-element" id="liveIndicator">
        <div class="live-dot"></div> LIVE
    </div>

    <div id="channelSwitcherContainer" class="ui-element">
        <button id="currentChannelBtn">
            <span class="material-icons-sharp" style="font-size: 16px;">tv</span>
            <span id="btnText">Fancode FHD</span>
            <span class="material-icons-sharp" style="font-size: 16px; margin-left: auto;">expand_more</span>
        </button>
        <ul id="channelList"></ul>
    </div>

    <!-- Firebase Overlay -->
    <div id="overlay-container">
        <img id="overlay-image" style="display:none;">
        <video id="overlay-video" style="display:none;" playsinline></video>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY",
authDomain: "movie-92659.firebaseapp.com",
databaseURL: "https://movie-92659-default-rtdb.firebaseio.com",
projectId: "movie-92659",
storageBucket: "movie-92659.firebasestorage.app",
messagingSenderId: "1090734362509",
appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4",
measurementId: "G-XF1TEP0DSJ"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const mainVideo = document.getElementById('video');
const overlayContainer = document.getElementById('overlay-container');
const overlayImg = document.getElementById('overlay-image');
const overlayVid = document.getElementById('overlay-video');
const myLogo = document.getElementById('myLogo');
const liveIndicator = document.getElementById('liveIndicator');
const channelSwitcher = document.getElementById('channelSwitcherContainer');

// Firebase Logic
onValue(ref(db, 'streamState'), (snapshot) => {
    const state = snapshot.val();
    if (state && state.active) {
        mainVideo.muted = true;
        myLogo.style.display = 'none'; // Only hide logo if OVERLAY is active
        liveIndicator.style.display = 'none';
        channelSwitcher.style.display = 'none';
        overlayContainer.style.display = 'flex';

        if (state.type === 'image') {
            overlayVid.style.display = 'none';
            overlayVid.pause();
            overlayImg.src = state.src;
            overlayImg.style.display = 'block';
        } else if (state.type === 'video') {
            overlayImg.style.display = 'none';
            if (overlayVid.src !== state.src) {
                overlayVid.src = state.src;
                overlayVid.style.display = 'block';
                overlayVid.load();
                overlayVid.play().catch(e => {});
            } else if (overlayVid.paused) {
                overlayVid.style.display = 'block';
                overlayVid.play();
            }
        }
    } else {
        overlayContainer.style.display = 'none';
        overlayVid.pause();
        overlayVid.src = "";
        mainVideo.muted = false;

        // Restore UI elements (Logo handled by player state)
        liveIndicator.style.display = 'flex';
        channelSwitcher.style.display = 'block';
        if(!mainVideo.paused) myLogo.style.display = 'block';
    }
});

overlayVid.addEventListener('ended', () => {
    update(ref(db, 'streamState'), { active: false });
});
</script>

<script>
const channels = [
{
name: 'Fancode FHD',
url: 'https://a166aivottlinear-a.akamaihd.net/OTTB/sin-nitro/live/clients/dash/enc/fdb3pubmek/out/v1/aefca6420f944a9482e117f315de535f/cenc.mpd',
drm: {
clearKeys: {
'7e9239c1982d984a002df3ed049d0756': '1b8a17598129a3618535c8fb05f103fe'
}
}
},
{
name: 'Fancode HD',
url: 'https://bd-mc-fdlive.fancode.com/mumbai/138239_english_hls_eb5430a5c152122_1ta-di_h264/index.m3u8',
drm: {}
}
];

let player;
const loader = document.getElementById('custom-loader');
const logo = document.getElementById('myLogo');

function showLoader(show) {
    if(show) {
        loader.style.display = 'block';
        // Note: Logo stays Visible during buffer/loading as requested
    } else {
        loader.style.display = 'none';
    }
}

async function initPlayer() {
    shaka.polyfill.installAll();
    if (!shaka.Player.isBrowserSupported()) return;

    const video = document.getElementById('video');
    const container = document.querySelector('.shaka-video-container');
    player = new shaka.Player(video);
    const ui = new shaka.ui.Overlay(player, container, video);

    // Removed 'fullscreen' from here to hide it
    ui.configure({
        'controlPanelElements': ['spacer', 'captions', 'quality', 'language'], // Fullscreen button removed
        'overflowMenuButtons': ['cast']
    });

    player.configure({
        streaming: { 
            lowLatencyMode: true, 
            bufferingGoal: 30, 
            rebufferingGoal: 5,
            jumpLargeGaps: true
        }
    });

    // --- EVENT LISTENERS ---
    
    player.addEventListener('buffering', (event) => {
        showLoader(event.buffering);
        // Logo logic removed from here so it stays
    });

    video.addEventListener('playing', () => {
        showLoader(false);
        if(document.getElementById('overlay-container').style.display !== 'flex'){
            logo.style.display = 'block';
        }
    });

    video.addEventListener('waiting', () => showLoader(true));
    video.addEventListener('seeking', () => showLoader(true));

    // --- CHANNEL SWITCHER UI ---
    const switcherBtn = document.getElementById('currentChannelBtn');
    const btnText = document.getElementById('btnText');
    const channelListEl = document.getElementById('channelList');

    channels.forEach((channel, index) => {
        const li = document.createElement('li');
        li.textContent = channel.name;
        li.dataset.index = index;
        if(index === 0) li.classList.add('active');
        channelListEl.appendChild(li);
    });

    switcherBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        channelListEl.classList.toggle('show');
        showControls();
    });

    channelListEl.addEventListener('click', async (event) => {
        if (event.target.tagName === 'LI') {
            const index = parseInt(event.target.dataset.index, 10);
            const selectedChannel = channels[index];

            btnText.textContent = selectedChannel.name;
            channelListEl.classList.remove('show');
            document.querySelectorAll('#channelList li').forEach(li => li.classList.remove('active'));
            event.target.classList.add('active');

            // --- SMOOTH SWITCHING LOGIC (NO WHITE FLASH) ---
            showLoader(true);
            // Don't hide logo here
            
            try {
                // Ensure black background
                video.style.background = '#000';
                await player.unload();
                
                player.configure({ drm: selectedChannel.drm });
                await player.load(selectedChannel.url);
                video.play().catch(()=>{});
            } catch (e) {
                console.error(e);
                showLoader(false);
            }
        }
    });

    document.addEventListener('click', (e) => {
        if (!switcherBtn.contains(e.target) && !channelListEl.contains(e.target)) {
            channelListEl.classList.remove('show');
        }
    });

    showLoader(true);
    try {
        player.configure({ drm: channels[0].drm });
        await player.load(channels[0].url);
    } catch (e) {
        showLoader(false);
    }

    // --- UI FADE CONTROLS ---
    const uiElements = document.querySelectorAll('.ui-element');
    let fadeTimeout;

    function showControls() {
        if(document.getElementById('overlay-container').style.display === 'flex') return;

        uiElements.forEach(el => el.classList.remove('fade-out'));
        container.style.cursor = 'auto';

        clearTimeout(fadeTimeout);
        fadeTimeout = setTimeout(() => {
            if (channelListEl.classList.contains('show')) return;
            uiElements.forEach(el => el.classList.add('fade-out'));
            container.style.cursor = 'none';
        }, 3000);
    }

    container.addEventListener('mousemove', showControls);
    container.addEventListener('touchstart', showControls);
    container.addEventListener('click', showControls);
    showControls();
}

document.addEventListener('DOMContentLoaded', initPlayer);
</script>

</body>
</html>
