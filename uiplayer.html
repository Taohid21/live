<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Stream</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.6.0/controls.min.css">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        .shaka-video-container { position: absolute; inset: 0; width: 100%; height: 100%; }
        video#video { width: 100%; height: 100%; object-fit: contain; }

        /* Overlay System */
        #overlay-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 20; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #overlay-media { width: 100%; height: 100%; object-fit: contain; }
        
        /* Countdown Badge */
        .back-on-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            z-index: 30;
        }
        .dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* UI Hiding */
        .hidden-ui { opacity: 0 !important; pointer-events: none !important; }
        
        /* Live Indicator */
        .live-indicator {
            position: absolute; bottom: 15px; left: 20px; color: white; font-weight: bold; z-index: 10;
            display: flex; align-items: center; gap: 10px; transition: opacity 0.5s;
        }
        .red-dot { width: 10px; height: 10px; background: red; border-radius: 50%; box-shadow: 0 0 10px red; }
        
        #myLogo { position: absolute; top: 10px; left: 20px; width: 80px; z-index: 15; }
        
        /* Shaka cleanups */
        .shaka-overflow-menu-button, .shaka-seek-bar-container, .shaka-current-time { display: none !important; }
    </style>
</head>
<body>

<div class="shaka-video-container">
    <video autoplay playsinline id="video"></video>
    
    <img id="myLogo" src="tiolive.png" style="display:none">
    
    <div class="live-indicator" id="liveTag">
        <div class="red-dot"></div> LIVE
    </div>

    <!-- Overlay Layer -->
    <div id="overlay-layer">
        <div class="back-on-badge">
            <div class="dot"></div>
            BACK ON: <span id="countdown">00:00</span>
        </div>
        <!-- Dynamic Media Element will be injected here -->
        <div id="media-container" style="width:100%; height:100%;"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    const firebaseConfig = {
  apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY",
  authDomain: "movie-92659.firebaseapp.com",
  databaseURL: "https://movie-92659-default-rtdb.firebaseio.com",
  projectId: "movie-92659",
  storageBucket: "movie-92659.firebasestorage.app",
  messagingSenderId: "1090734362509",
  appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4",
  measurementId: "G-XF1TEP0DSJ"
};

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const mainVideo = document.getElementById('video');
    const overlayLayer = document.getElementById('overlay-layer');
    const mediaContainer = document.getElementById('media-container');
    const countdownEl = document.getElementById('countdown');
    const liveTag = document.getElementById('liveTag');
    const myLogo = document.getElementById('myLogo');
    
    let timerInterval;

    onValue(ref(db, 'streamState'), (snapshot) => {
        const state = snapshot.val();

        if (state && state.active) {
            // --- AD/VIDEO MODE ---
            mainVideo.muted = true;
            overlayLayer.style.display = 'flex';
            liveTag.style.opacity = '0';
            myLogo.style.display = 'none';

            // Handle Media Type
            mediaContainer.innerHTML = '';
            let element;
            if (state.type === 'video') {
                element = document.createElement('video');
                element.src = state.src;
                element.autoplay = true;
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.objectFit = 'contain';
            } else {
                element = document.createElement('img');
                element.src = state.src;
                element.style.width = '100%';
                element.style.height = '100%';
                element.style.objectFit = 'contain';
            }
            mediaContainer.appendChild(element);

            // Start Countdown logic
            clearInterval(timerInterval);
            // Calculate end time based on start time + duration
            const endTime = state.startTime + (state.duration * 1000);
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const left = Math.ceil((endTime - now) / 1000);
                
                if (left <= 0) {
                    countdownEl.innerText = "SOON";
                } else {
                    const m = Math.floor(left / 60).toString().padStart(2, '0');
                    const s = (left % 60).toString().padStart(2, '0');
                    countdownEl.innerText = `${m}:${s}`;
                }
            }, 1000);

        } else {
            // --- LIVE MODE ---
            clearInterval(timerInterval);
            overlayLayer.style.display = 'none';
            mediaContainer.innerHTML = '';
            
            mainVideo.muted = false;
            liveTag.style.opacity = '1';
            if(!mainVideo.paused) myLogo.style.display = 'block';
        }
    });
</script>

<script>
    // Shaka Player Logic (Standard)
    async function initPlayer() {
        const streamUrl = 'https://a201aivottlinear-a.akamaihd.net/OTTB/lhr-nitro/clients/dash/enc/f60kqesunw/out/v1/a435ed7a00f947deb4369b46d8f2fb70/cenc.mpd';
        const keyId = '1779c27b9d077a3ba0c9cc1bb9a94b9f';
        const key = 'cc5cf3b7928fb9e0a1ee6a8b566f0a8e';

        shaka.polyfill.installAll();
        if (!shaka.Player.isBrowserSupported()) return;

        const video = document.getElementById('video');
        const player = new shaka.Player(video);
        const ui = new shaka.ui.Overlay(player, document.querySelector('.shaka-video-container'), video);
        
        ui.configure({ 'controlPanelElements': ['quality', 'spacer'] }); // Minimal controls

        player.configure({ drm: { clearKeys: { [keyId]: key } } });

        video.addEventListener('playing', () => {
            if(document.getElementById('overlay-layer').style.display === 'none')
                document.getElementById('myLogo').style.display = 'block';
        });

        try { await player.load(streamUrl); video.play(); } catch (e) {}
    }
    document.addEventListener('DOMContentLoaded', initPlayer);
</script>

</body>
</html>
