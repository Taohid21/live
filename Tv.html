<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport" />
    <title>Ti Sports - The Unlimited Entertainment Here</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2&display=swap" rel="stylesheet">

<style>
    :root {
        --primary-color: #ff4f00;
        --bg-dark: #0a0a0a;
        --card-bg: #1a1a1a;
        --font-main: 'Poppins', sans-serif;
        --accent-green: #4ade80; 
    }

    /* --- Drawer Styles --- */
    body.drawer-open {
        overflow: hidden;
    }
    #drawer-overlay {
        transition: opacity 0.3s ease-in-out;
    }
    body.drawer-open #drawer-overlay {
        display: block;
        opacity: 1;
    }
    body.drawer-open #nav-drawer {
        transform: translateX(0);
        box-shadow: 10px 0 40px rgba(0,0,0,0.5);
    }
    .drawer-link {
        display: flex;
        align-items: center;
        padding: 12px;
        gap: 1rem;
        border-radius: 8px;
        color: #d1d5db; /* text-gray-300 */
        font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .drawer-link:hover, .drawer-link:focus {
        background-color: rgba(255, 79, 0, 0.15);
        color: var(--primary-color);
    }
    .drawer-link i {
        font-size: 1.1rem;
        text-align: center;
    }
    html { scroll-behavior: smooth; }
    body { 
        font-family: var(--font-main);
        background-color: var(--bg-dark);
        color: #f0f0f0;
        overflow-x: hidden;
    }

    /* --- Main App Shell Styles --- */
    #app-shell { 
        display: flex; 
        flex-direction: column; 
        min-height: 100vh; 
    }
    main { flex-grow: 1; }
    .main-header { rgba(10, 10, 10, 0.7); backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px); border-bottom: 1px solid rgba(255, 255, 255, 0.07); }
    #banner-container { height: 56.25vw; max-height: 450px; min-height: 220px; background-color: #1f1f1f; }
    .swiper-slide { display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .swiper-slide a { display: block; width: 100%; height: 100%; position: relative; }
    .swiper-slide a::after { content: ''; position: absolute; left: 0; bottom: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(10, 10, 10, 0.9), transparent); z-index: 1; }
    .swiper-slide img { width: 100%; height: 100%; object-fit: cover; }
    .swiper-pagination-bullet-active { background-color: var(--primary-color); }
    .banner-play-icon { position: absolute; bottom: 20px; right: 20px; z-index: 2; width: 50px; height: 50px; background-color: rgba(255, 79, 0, 0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; border: 2px solid rgba(255, 255, 255, 0.5); backdrop-filter: blur(5px); animation: pulse-play 2s infinite; }
    @keyframes pulse-play { 0% { box-shadow: 0 0 0 0 rgba(255, 79, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 79, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 79, 0, 0); } }
    .section-title-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .section-title { display: flex; align-items: center; gap: 0.75rem; }
    .section-title .accent-bar { width: 5px; height: 24px; background-color: var(--primary-color); border-radius: 99px; }
    .section-title h2 { font-weight: 700; font-size: 1.25rem; }
    .content-card { background-color: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
    .content-card:hover { border-color: var(--accent-green); transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.5); }
    .card-img-container { position: relative; }
    .play-icon-overlay { position: absolute; inset: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
    .content-card:hover .play-icon-overlay { opacity: 1; }
    .play-icon-overlay .main-play-icon { font-size: 40px; color: white; }
    .live-tv-channel { display: block; position: relative; transition: transform 0.3s ease; }
    .live-tv-channel:hover { transform: scale(1.05); } .live-tv-channel img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 50%; border: 2px solid var(--accent-green); }
    .badge { position: absolute; top: 10px; font-size: 10px; font-weight: 600; padding: 4px 8px; border-radius: 7px; backdrop-filter: blur(5px); color: white; z-index: 3; }
    .badge-live { left: 10px; background-color: rgba(239, 68, 68, 0.85); display: flex; align-items: center; gap: 5px; }
    .badge-upcoming {
        left: 10px;
        background-color: rgba(34, 197, 94, 0.85);
        display: flex;
        align-items: center;
        gap: 5px;
        animation: upcoming-glow 2.5s infinite ease-in-out;
    }
    .badge-highlights {
        left: 10px;
        background-color: rgba(59, 130, 246, 0.85); /* A nice blue color */
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .badge-new { right: 10px; background: red; animation: new-pop 0.5s ease-out; }
    
    .badge-duration {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background-color: rgba(0, 0, 0, 0.75);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        z-index: 3;
    }

    @keyframes new-pop { from { transform: scale(0.5) translateX(10px); opacity: 0; } to { transform: scale(1) translateX(0); opacity: 1; } }
    .live-dot { width: 7px; height: 7px; background-color: #fff; border-radius: 50%; animation: live-pulse 1.5s infinite; }
    @keyframes live-pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .bottom-nav { 
        position: fixed; 
        bottom: 0; 
        left: 0; 
        right: 0; 
        height: 70px; 
        background: rgba(10, 10, 10, 0.8); 
        backdrop-filter: blur(10px); 
        border-top: 1px solid rgba(255, 255, 255, 0.1); 
        display: flex; 
        justify-content: space-around; 
        align-items: center; 
        z-index: 50; 
        padding-bottom: env(safe-area-inset-bottom); 
    }
    .nav-button { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        justify-content: center; 
        gap: 4px; 
        color: #888; 
        font-size: 11px; 
        font-weight: 500; 
        transition: color 0.3s, transform 0.3s; 
        flex: 1; 
        height: 100%; 
    }
    .nav-button.active { 
        color: var(--primary-color); 
    } 
    .nav-button i, .nav-button img { 
        font-size: 20px; 
        height: 22px; 
        transition: transform 0.3s; 
    } 
    .nav-button.active i, .nav-button.active img { 
        transform: scale(1.1); 
    }
    .nav-button img { 
        filter: grayscale(100%) brightness(1.2); 
    } 
    .nav-button.active img { 
        filter: none; 
    }
    .page-content { display: none; animation: contentFadeIn 0.5s ease-out; }
    .page-content.active { display: block; }
    @keyframes contentFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    #search-overlay { 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background-color: rgba(10, 10, 10, 0.9); 
        backdrop-filter: blur(16px); 
        z-index: 200; 
        display: none; 
        opacity: 0; 
        transition: opacity 0.3s ease-in-out; 
    }
    body.search-overlay-active #search-overlay { display: flex; opacity: 1; }
    
    .search-result-item { 
        display: flex; 
        align-items: center; 
        padding: 10px; 
        margin-bottom: 10px; 
        background-color: rgba(255,255,255,0.05); 
        border-radius: 8px; 
        transition: background-color 0.3s; 
    } 
    .search-result-item:hover { background-color: rgba(255,255,255,0.1); }
    .search-result-item img { 
        width: 50px; 
        height: 75px; 
        object-fit: cover; 
        border-radius: 4px; 
        margin-right: 15px; 
    }

    /* --- Enhanced Search Overlay Styles --- */
    #search-overlay {
        transition: opacity 0.3s ease-in-out;
    }
    #search-input::placeholder {
        color: #6b7280; /* text-gray-500 */
    }
    #search-input {
        padding-right: 6rem; /* ইনপুটের ভেতরের আইকনগুলোর জন্য জায়গা */
    }
    #voice-search-btn.recording i {
        color: var(--primary-color);
        animation: pulse-mic 1.5s infinite;
    }
    @keyframes pulse-mic {
        0% { transform: scale(1); }
        50% { transform: scale(1.15); }
        100% { transform: scale(1); }
    }

    #top-searches-container {
        animation: contentFadeIn 0.5s ease-out;
    }
    .top-search-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background-color: rgba(255, 255, 255, 0.07);
        color: #d1d5db; /* text-gray-300 */
        padding: 8px 14px;
        border-radius: 9999px;
        font-weight: 500;
        font-size: 0.875rem; /* 14px */
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        border: 1px solid transparent;
    }
    .top-search-pill:hover {
        background-color: rgba(var(--primary-color-rgb), 0.2);
        color: var(--primary-color);
        border-color: var(--primary-color);
        transform: translateY(-2px);
    }
    
    #grid-page-view { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-dark); z-index: 100; overflow-y: auto; }
    .shimmer { background: linear-gradient(90deg, #1a1a1a 25%, #2a2a2a 50%, #1a1a1a 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }
    .skeleton-card { border-radius: 12px; overflow: hidden; background-color: var(--card-bg); }
    .skeleton-card .img { height: 0; padding-bottom: 150%; background-color: #2a2a2a; } .skeleton-card .img.thumbnail { padding-bottom: 56.25%; }
    .skeleton-card .title { height: 20px; margin-top: 8px; background-color: #2a2a2a; border-radius: 4px; width: 80%; }
    .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

    /* --- Player Page Styles (Final) --- */
    #player-page-view { display: none; background-color: #000; color: #fff; font-family: 'Baloo 2', cursive; }
    #player-wrapper { position: relative; width: 100%; background-color: #000; transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
    #player-wrapper .player-content { position: relative; width: 100%; padding-top: 56.25%; display: flex; align-items: center; justify-content: center; }
    #player-wrapper .player-content iframe, #player-wrapper .player-content video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; object-fit: contain; }
    .player-loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 25; display: none; }
    .player-loader i { font-size: 48px; color: rgba(255,255,255,0.8); }
    #player-wrapper.loading .player-loader { display: block; }
    #player-wrapper.loading .player-content > i { display: none; }
    #player-wrapper.rotated-view { position: fixed; top: 0; left: 0; width: 100vh; height: 100vw; transform-origin: center; transform: rotate(90deg) translate(calc((100vh - 100vw) / 2), calc((100vh - 100vw) / 2)); z-index: 9999; background: #000; }
    #player-wrapper.rotated-view .player-content { width: 100%; height: 100%; padding-top: 0; }
    .view-mode-btn { position: absolute; color: white; background: none; border: none; width: 50px; height: 50px; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; z-index: 22; text-shadow: 0 0 8px rgba(0,0,0,0.8); transition: opacity 0.3s; }
    .enter-rotated-view-btn { bottom: 5px; right: 5px; } 
    .controls-bottom-bar .enter-rotated-view-btn { position: static; } 
    #player-wrapper.rotated-view .enter-rotated-view-btn { display: none; }
    /* --- পরিবর্তিত কোড: Exit বাটনের অবস্থান ঠিক করা হয়েছে --- */
    .close-rotated-view-btn {
        top: 15px;
        left: 15px;
        display: none;
        transform: rotate(0deg); /* এখন আর ঘোরানোর দরকার নেই */
        color: var(--primary-color);
        background-color: rgba(26, 26, 26, 0.7);
        border-radius: 50%;
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        width: 45px;
        height: 45px;
    }
    #player-wrapper.rotated-view .close-rotated-view-btn { display: flex; }
    #custom-controls-overlay { position: absolute; inset: 0; z-index: 20; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; background: radial-gradient(circle, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 70%); pointer-events: none; }
    #custom-controls-overlay.visible { opacity: 1; }
    #custom-play-pause-btn { pointer-events: auto; width: 75px; height: 75px; background: radial-gradient(circle, rgba(255, 79, 0, 0.7) 0%, rgba(255, 79, 0, 0.4) 100%); border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 50%; color: white; font-size: 34px; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); cursor: pointer; transition: all 0.2s ease; box-shadow: 0 0 25px rgba(255, 79, 0, 0.4); }
    #custom-play-pause-btn:hover { transform: scale(1.1); box-shadow: 0 0 35px rgba(255, 79, 0, 0.6); } 
    #custom-play-pause-btn .fa-play { margin-left: 6px; }
    #player-controls-container { position: absolute; bottom: 0; left: 0; right: 0; z-index: 21; padding: 10px 15px; background: linear-gradient(to top, rgba(0,0,0,0.85), transparent); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; display: flex; flex-direction: column; gap: 8px; }
    #player-wrapper.controls-visible #player-controls-container { opacity: 1; visibility: visible; }
    .controls-bottom-bar { display: flex; justify-content: space-between; align-items: center; color: white; font-size: 14px; font-weight: 500; width: 100%; }
    .controls-left, .controls-right { display: flex; align-items: center; gap: 1rem; }
    #time-display { font-family: 'Poppins', sans-serif; letter-spacing: 0.5px; }
    #double-tap-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; z-index: 19; }
    .tap-zone { flex: 1; height: calc(100% - 80px); }
    .vertical-indicator { position: absolute; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 12px; width: 36px; padding: 15px 0; background-color: rgba(0, 0, 0, 0.6); border-radius: 18px; opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; z-index: 25; pointer-events: none; }
    .vertical-indicator.visible { opacity: 1; visibility: visible; }
    .vertical-indicator i { font-size: 18px; color: white; }
    .vertical-indicator .indicator-bar-container { width: 5px; height: 100px; background-color: rgba(255, 255, 255, 0.3); border-radius: 5px; position: relative; overflow: hidden; }
    .vertical-indicator .indicator-bar-level { position: absolute; bottom: 0; left: 0; width: 100%; background-color: white; border-radius: 5px; transition: height 0.1s linear; }
    #volume-indicator-v { right: 30px; }
    #brightness-indicator-v { left: 30px; }
    #player-wrapper.rotated-view #volume-indicator-v { right: 50px; }
    #player-wrapper.rotated-view #brightness-indicator-v { left: 50px; }
    #player-page-view main { padding-bottom: 20px; }
    .player-related-card.is-poster .image-container { width: 100%; height: 160px; } .player-related-card.is-logo .image-container { width: 100px; height: 100px; border-radius: 12px; }
    .player-related-card img:hover { transform: scale(1.05); }
    #comment-section { position: fixed; bottom: 0; left: 0; right: 0; height: 70%; background-color: #121212; border-top: 1px solid #282828; transform: translateY(100%); transition: transform 0.4s ease-in-out; z-index: 150; padding-bottom: env(safe-area-inset-bottom); }
    #comment-section.open { transform: translateY(0); }
    /* --- Banner Ad Container Styles (Enhanced) --- */
    #ad-container {
        position: fixed;
        bottom: 70px;
        left: 0;
        right: 0;
        width: 100%;
        height: 50px;
        background-color: #ffffff;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 50;
        overflow: hidden;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease-in-out;
    }

    /* --- Player Control Button Images --- */
    .player-control-btn img {
        width: 20px;
        height: 20px;
        filter: brightness(0) invert(1);
        transition: transform 0.2s;
    }
    .player-control-btn:hover img {
        transform: scale(1.1);
    }

    /* --- Live TV Controls --- */
    #player-controls-container-live {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 21;
        padding: 12px 15px;
        background: linear-gradient(to top, rgba(0,0,0,0.85), transparent);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s, visibility 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #player-wrapper.controls-visible #player-controls-container-live {
        opacity: 1;
        visibility: visible;
    }
    /* --- পরিবর্তিত কোড: Live ডট অ্যালাইনমেন্ট ঠিক করা হয়েছে --- */
    .live-indicator {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        font-weight: 600;
        color: white;
        text-shadow: 0 0 5px red;
    }
    .live-indicator::before {
        content: '•';
        color: red;
        font-size: 24px;
        animation: live-pulse 1.5s infinite;
        line-height: 1; /* ভার্টিকাল অ্যালাইনমেন্টের জন্য */
    }
    .live-controls-right {
        display: flex;
        align-items: center;
        gap: 1.25rem; /* 20px */
    }
    #settings-panel {
        position: absolute;
        bottom: 60px; /* কন্ট্রোল বারের উপরে */
        right: 55px;
        background-color: rgba(26, 26, 26, 0.9);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        padding: 8px;
        display: none;
        flex-direction: column;
        gap: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    #settings-panel.visible {
        display: flex;
    }
    .resolution-option {
        background: none;
        border: none;
        color: #e0e0e0;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        text-align: left;
        width: 100%;
    }
    .resolution-option:hover {
        background-color: rgba(255, 79, 0, 0.5);
        color: white;
    }

    /* --- Improved Movie Progress Bar --- */
    #progress-container {
        width: 100%;
        height: 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    #progress-bar-wrapper {
        position: relative;
        width: 100%;
        height: 5px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
        transition: height 0.2s ease;
    }
    #progress-container:hover #progress-bar-wrapper {
        height: 8px;
    }
    #progress-buffered {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.5);
        border-radius: 5px;
        transition: width 0.1s linear;
    }
    #progress-played {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background-color: var(--primary-color);
        border-radius: 5px;
        z-index: 1;
        pointer-events: none;
    }
    #progress-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 100%;
        background: transparent;
        outline: none;
        position: relative;
        z-index: 2;
        margin: 0;
    }
    /* --- নতুন সমাধান: প্রগ্রেস বারের Thumb (ডট) পুরোপুরি হাইড করা হলো --- */
#progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    /* ডটটিকে অদৃশ্য করার জন্য এর কোনো আকার বা রঙ থাকবে না */
    width: 0;
    height: 0;
    background: transparent;
    cursor: pointer;
}

#progress-bar::-moz-range-thumb {
    /* ডটটিকে অদৃশ্য করার জন্য এর কোনো আকার বা রঙ থাকবে না */
    width: 0;
    height: 0;
    background: transparent;
    border: 0;
    cursor: pointer;
}

    /* --- Fit to Screen Button and Video Style --- */
    #fit-screen-btn {
        display: none;
    }
    #player-wrapper.rotated-view #fit-screen-btn {
        display: block;
    }
    #player-wrapper .player-content video {
        object-fit: contain;
    }
    #player-wrapper .player-content video.video-fit-cover {
        object-fit: cover;
        transform-origin: center center;
    }
</style>

</head>
<body>
    <div id="drawer-overlay" class="fixed inset-0 bg-black/60 z-[90] hidden"></div>
    <nav id="nav-drawer" class="fixed top-0 left-0 h-full w-72 max-w-[80vw] bg-gradient-to-b from-[#1a1a1a] to-[#121212] z-[91] flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out">
        <div class="flex items-center gap-4 p-5 border-b border-gray-700/50">
            <img src="https://tiotv.netlify.app/20251104_204432.png" alt="App Logo" class="w-14 h-14 rounded-full border-2 border-[var(--primary-color)] object-cover">
            <div>
                <h2 class="text-2xl font-bold text-white" style="font-family: 'Baloo 2', cursive;">tioTV</h2>
                <p class="text-xs text-gray-400">Unlimited Entertainment</p>
            </div>
        </div>
        <div class="flex-grow p-4 overflow-y-auto">
            <div class="space-y-2">
                 <a href="go:gzone" class="drawer-link text-base"><i class="fas fa-gamepad w-6 text-[var(--primary-color)]"></i><span>Games Zone</span></a>
                 <a href="go:support" class="drawer-link text-base"><i class="fas fa-headset w-6 text-[var(--primary-color)]"></i><span>User Support</span></a>
            </div>
            <hr class="border-gray-700/60 my-4">
            <div>
                <div class="text-gray-400 text-sm font-semibold mb-3 px-3">SETTINGS</div>
                <div class="flex items-center justify-between bg-gray-800/50 rounded-lg px-3 py-2.5">
                    <label for="autoplay-toggle" class="font-medium text-gray-200">Autoplay Next</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="autoplay-toggle" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[var(--primary-color)]"></div>
                    </label>
                </div>
            </div>
            <hr class="border-gray-700/60 my-4">
            <div>
                <div class="text-gray-400 text-sm font-semibold mb-3 px-3">CONNECT WITH US</div>
                 <a href="https://great-family-tv.github.io/download/" class="drawer-link"><i class="fas fa-globe-americas w-6"></i><span>Visit Website</span></a>
                 <a href="https://t.me/GreatFamilyTv" class="drawer-link"><i class="fab fa-telegram-plane w-6"></i><span>Join Telegram</span></a>
                 <a href="#" class="drawer-link"><i class="fas fa-shield-alt w-6"></i><span>Privacy Policy</span></a>
            </div>
        </div>
        <div class="text-center text-gray-500 text-xs p-4 border-t border-gray-700/50">Version 1.0 | By Taohid Islam</div>
    </nav>

    <!-- ধাপ ২: মূল স্ক্রলেবল কন্টেন্ট -->
    <div id="app-shell">
        <header class="main-header flex items-center justify-between px-4 h-[60px] sticky top-0 z-40">
            <div class="flex items-center gap-4">
                <button id="drawer-open-btn" aria-label="Open Menu" class="text-2xl text-gray-300 hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-bars"></i></button>
                <div id="header-title-container" class="flex items-center gap-3">
                    <i id="page-title-icon" class="text-2xl transition-all duration-300 ease-in-out"></i>
                    <h1 id="page-title-header" class="text-xl font-bold text-white transition-opacity duration-300 ease-in-out"></h1>
                </div>
            </div>
            <button id="search-open-btn" aria-label="Search" class="text-2xl text-gray-300 hover:text-[var(--primary-color)] transition-colors"><i class="fas fa-search"></i></button>
        </header>
        <main class="p-4 md:p-6">
            <div id="home-page" class="page-content active"><section id="banner-container" class="relative w-full group mb-8 rounded-lg overflow-hidden"><div class="shimmer w-full h-full"></div></section><div id="home-sections-container" class="space-y-8"></div></div>
            <div id="livetv-page" class="page-content">
    <!-- নতুন ক্যাটাগরি বার এখানে যোগ হবে -->
    <div id="livetv-category-bar" class="flex overflow-x-auto gap-3 pb-3 mb-4 scrollbar-hide -mx-4 px-4">
        <!-- ক্যাটাগরি বাটনগুলো জাভাস্ক্রিপ্ট দিয়ে এখানে লোড হবে -->
    </div>

    <!-- চ্যানেলগুলো দেখানোর গ্রিড -->
    <div id="livetv-grid-container" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">
        <!-- চ্যানেল কার্ডগুলো জাভাস্ক্রিপ্ট দিয়ে এখানে লোড হবে -->
    </div>
</div><div id="cricket-page" class="page-content space-y-8"></div><div id="movies-page" class="page-content space-y-8"></div>
        </main>
        <footer class="bg-[#0B0B0B] text-gray-400 pt-10 text-sm mt-auto"></footer>
    </div>
<div id="ad-container">
    <img src="https://banglarmritshilpo.top/InShot_20251108_225429253.gif" alt="ব্যানার ইমেজ" style="width: 100%; height: auto; display: block;">
</div>
    <nav class="bottom-nav">
        <button data-target="home-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772401184834694.png" alt="Home" class="h-10 w-6"/><span>HOME</span></button>
        <button data-target="livetv-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772377272974914.png" alt="Live TV" class="h-10 w-6"/><span>LIVE TV</span></button>
        <button data-target="cricket-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/786352897906669.png" alt="Sports" class="h-10 w-6"/><span>SPORTS</span></button>
        <button data-target="movies-page" class="nav-button"><img src="https://www.easykoro.com/inventories/fit-in/600x800/772144044690327.png" alt="Movies" class="h-10 w-6"/><span>MOVIES</span></button>
    </nav>

    <!-- ধাপ ৪: অন্যান্য ফুল-স্ক্রিন ওভারলে -->
    <div id="grid-page-view">
        <header class="flex items-center p-4 bg-black/90 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-800"><button id="grid-back-btn" class="text-xl mr-4 hover:text-[var(--primary-color)]"><i class="fas fa-arrow-left"></i></button><h2 id="grid-page-title" class="text-lg font-bold truncate"></h2></header>
        <main id="grid-page-content" class="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></main>
    </div>
    <div id="search-overlay" class="flex-col p-4">
        <header class="flex items-center w-full mb-4 gap-3">
            <button id="search-back-btn" aria-label="Close Search" class="text-2xl text-gray-300 hover:text-white transition-colors flex-shrink-0"><i class="fas fa-arrow-left"></i></button>
            <div class="relative w-full flex-grow">
                <input id="search-input" type="text" placeholder="Search" class="w-full bg-[#1a1a1a] text-lg text-white placeholder-gray-500 rounded-full py-2.5 pl-5 pr-24 focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] transition-all duration-300">
                <div class="absolute inset-y-0 right-0 flex items-center pr-4 gap-3">
                    <button id="search-clear-btn" aria-label="Clear Search" class="text-xl text-gray-400 hover:text-white hidden"><i class="fas fa-times-circle"></i></button>
                    <button id="voice-search-btn" aria-label="Search with voice" class="text-xl text-gray-300 hover:text-[var(--primary-color)]"><i class="fa-solid fa-microphone"></i></button>
                </div>
            </div>
        </header>
        <main id="search-results-container" class="w-full flex-1 overflow-y-auto pr-2 scrollbar-hide">
            <div id="top-searches-container">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fas fa-fire text-[var(--primary-color)]"></i> Top Searches</h3>
                <div id="top-searches-pills" class="flex flex-wrap gap-3"></div>
                 <p class="text-xs text-gray-600 mt-6 text-center">© 2025 Rafid All Rights Reserved</p>
            </div>
            <div id="search-results-list" class="hidden"></div>
            <div id="search-no-results" class="text-center text-gray-500 mt-10 hidden">No results found.</div>
        </main>
    </div>
    <div id="player-page-view">
         <header class="p-4 bg-black/90 backdrop-blur-sm sticky top-0 z-20 flex items-center"><button id="player-back-btn" class="text-xl mr-4 hover:text-[var(--primary-color)]"><i class="fas fa-arrow-left"></i></button><h2 id="player-page-title-header" class="text-lg font-bold truncate"></h2></header>
        <section id="player-container" class="w-full bg-black">
            <div id="player-wrapper"><div class="player-content"><i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i></div></div>
        </section>
        <main class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <section id="action-bar" class="py-4 flex flex-wrap gap-4 items-center justify-between text-gray-400 border-b border-gray-800"><div class="flex items-center space-x-6"><button id="like-btn" class="action-btn flex items-center space-x-2"><i class="far fa-thumbs-up text-xl"></i><span id="like-count">0</span></button><button id="dislike-btn" class="action-btn flex items-center space-x-2"><i class="far fa-thumbs-down text-xl"></i><span id="dislike-count">0</span></button><button id="comment-btn" class="action-btn flex items-center space-x-2"><i class="far fa-comment-alt text-xl"></i><span>Comment</span></button></div><button id="report-btn" class="action-btn flex items-center space-x-2"><i class="far fa-flag text-xl"></i><span>Report</span></button></section>
            <section id="movie-info" class="py-6"></section>
            <section id="related-content" class="py-6"><h3 id="related-title" class="text-white text-lg font-semibold mb-3"></h3><div id="related-content-container" class="flex items-start space-x-4 overflow-x-auto scrollbar-hide pb-2"></div></section>
        </main>
        <section id="comment-section" class="flex flex-col"><header class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-lg font-semibold">Comments</h3><button id="close-comments-btn" class="text-2xl hover:text-white text-gray-400">×</button></header><div id="comments-list" class="flex-grow p-4 overflow-y-auto"></div><form id="comment-form" class="p-4 border-t border-gray-700 flex items-center"><input id="comment-input" type="text" class="w-full bg-gray-800 text-white rounded-l-md p-2 focus:outline-none focus:ring-2 focus:ring-green-600" placeholder="Add a comment..."><button type="submit" class="bg-green-600 text-white p-2 rounded-r-md hover:bg-green-700">Send</button></form></section>
    </div>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<!-- আপনার পুরোনো <script> ব্লকটি ডিলিট করে নিচের সম্পূর্ণ নতুন ব্লকটি পেস্ট করুন -->
<!-- আপনার পুরোনো <script type="module"> ব্লকটি ডিলিট করে নিচের সম্পূর্ণ নতুন ব্লকটি পেস্ট করুন -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, doc, onSnapshot, addDoc, serverTimestamp, updateDoc, increment, where, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyAb8YsPMOY53GxiycCL6G0MPZdgWe3nnyY", authDomain: "movie-92659.firebaseapp.com", projectId: "movie-92659", storageBucket: "movie-92659.appspot.com", messagingSenderId: "1090734362509", appId: "1:1090734362509:web:86be5583f6e8fcfdfa77c4" };
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const YOUTUBE_API_KEY = "AIzaSyBFxF8kRg7VdxYKsQdFO-WQkdxS9vF-B6M"; // অনুগ্রহ করে আপনার YouTube API কী এখানে দিন

const PlayerIcons = {
    play: "https://cdn-icons-png.flaticon.com/128/7238/7238961.png",
    pause: "https://cdn-icons-png.flaticon.com/128/6520/6520121.png",
    fullscreen: "https://cdn-icons-png.flaticon.com/128/7304/7304806.png",
    exitFullscreen: "https://cdn-icons-png.flaticon.com/128/8669/8669479.png",
    fitScreen: "https://cdn-icons-png.flaticon.com/128/80/80998.png",
    subtitle: "https://cdn-icons-png.flaticon.com/512/5009/5009382.png",
    settings: "https://cdn-icons-png.freepik.com/256/8999/8999687.png?semt=ais_white_label",
};

const UI = {  appShell: document.getElementById('app-shell'),  playerPageView: document.getElementById('player-page-view'),  pages: document.querySelectorAll('.page-content'),  bannerContainer: document.getElementById('banner-container'),  gridPageView: document.getElementById('grid-page-view'),  gridPageTitle: document.getElementById('grid-page-title'),  gridPageContent: document.getElementById('grid-page-content'),  searchOverlay: document.getElementById('search-overlay'),  searchInput: document.getElementById('search-input'),  searchResultsContainer: document.getElementById('search-results-container'),  pageTitleHeader: document.getElementById('page-title-header'),  pageTitleIcon: document.getElementById('page-title-icon'),
    adContainer: document.getElementById('ad-container'),
    bottomNav: document.querySelector('.bottom-nav')
};

const adContainer = document.getElementById('ad-container');
const mainContent = document.querySelector('#app-shell main');

if (adContainer && mainContent) {
    const adObserver = new MutationObserver(() => {
        const isAdVisible = adContainer.style.display !== 'none' && adContainer.offsetHeight > 0;
        const navHeight = 70; const adHeight = 50;
        mainContent.style.marginBottom = isAdVisible ? `${navHeight + adHeight}px` : `${navHeight}px`;
    });
    adObserver.observe(adContainer, { attributes: true, childList: true, subtree: true });
    setTimeout(() => {
        const isAdVisibleInitially = adContainer.style.display !== 'none' && adContainer.offsetHeight > 0;
        const navHeight = 70; const adHeight = 50;
        mainContent.style.marginBottom = isAdVisibleInitially ? `${navHeight + adHeight}px` : `${navHeight}px`;
    }, 100);
}

const getMatchStatus = (startTime, endTime) => {
    if (!startTime || !endTime || typeof startTime.toDate !== 'function' || typeof endTime.toDate !== 'function') {
        return { status: 'unknown' };
    }
    const now = new Date();
    const start = startTime.toDate();
    const end = endTime.toDate();

    if (now < start) {
        return { status: 'upcoming' };
    } else if (now >= start && now <= end) {
        return { status: 'live' };
    } else {
        return { status: 'finished' };
    }
};

const Render = {
    card: (item, cardType = 'poster', isGridItem = false) => {
        const aspectClass = cardType === 'thumbnail' ? 'aspect-video' : 'aspect-[2/3]';
        let badges = '';
        
        if (item.duration) { 
            badges += `<span class="badge-duration">${item.duration}</span>`; 
        } else if (cardType === 'thumbnail') {
            const highlightKeywords = ['highlights', 'extended', 'full match', 'recap', 'replay', 'classic match'];
            const title = (item.title || '').toLowerCase();
            const statusInfo = getMatchStatus(item.startTime, item.endTime);

            if (statusInfo.status === 'live') {
                badges += `<span class="badge badge-live"><span class="live-dot"></span>Live</span>`;
            } else if (statusInfo.status === 'upcoming') {
                badges += `<span class="badge badge-upcoming"><i class="far fa-clock"></i> Upcoming</span>`;
            } else if (statusInfo.status === 'finished') {
                if (highlightKeywords.some(keyword => title.includes(keyword))) {
                    badges += `<span class="badge badge-highlights"><i class="fas fa-history"></i> Highlights</span>`;
                } else {
                    badges += `<span class="badge badge-highlights" style="background-color: #6b7280; gap: 5px;"><i class="fas fa-check-circle"></i> Finished</span>`;
                }
            }
        }

        if (cardType !== 'thumbnail' && item.createdAt && (Date.now() - item.createdAt.toDate().getTime()) < 24 * 60 * 60 * 1000) { 
            badges += `<span class="badge badge-new">NEW</span>`; 
        }

        const sizeClass = isGridItem ? 'w-full' : (cardType === 'thumbnail' ? 'w-60 flex-shrink-0' : 'w-36 sm:w-40 flex-shrink-0');
        const fallbackImage = 'https://via.placeholder.com/300x450.png?text=Image+Not+Found';
        
        return `<div class="${sizeClass}">
                    <a href="#" data-id="${item.link}" class="block group content-link">
                        <div class="content-card">
                            <div class="card-img-container relative ${aspectClass}">
                                ${badges}
                                <img alt="${item.title || item.name}" class="w-full h-full object-cover" src="${item.posterUrl}" loading="lazy" onerror="this.onerror=null;this.src='${fallbackImage}';"/>
                                <div class="play-icon-overlay"><i class="fas fa-play main-play-icon"></i></div>
                            </div>
                        </div>
                        <p class="text-sm font-semibold mt-2 truncate group-hover:text-[var(--primary-color)] transition-colors">${item.title || item.name}</p>
                    </a>
                </div>`;
    },
    liveTvChannelCard: (item, isGridItem = false) => {
        const containerClasses = isGridItem ? 'w-full text-center' : 'flex-shrink-0 w-24 text-center';
        return `<div class="${containerClasses}"><a href="#" data-id="liveTV/${item.id}" data-stream-url="${item.streamUrl || ''}" class="live-tv-channel content-link"><img src="${item.logoUrl}" alt="${item.name}" onerror="this.onerror=null;this.src='https://via.placeholder.com/100x100.png?text=Logo';" /></a><p class="text-xs mt-1 truncate font-medium text-gray-300">${item.name}</p></div>`;
    },
    section: (s, i, t, d) => `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>${s.title}</h2></div><button class="see-more-btn text-xs font-semibold text-gray-400 hover:text-[var(--primary-color)]" data-title="${s.title}" data-type="${t}" data-section-id="${d}">View All <i class="fas fa-angle-right ml-1"></i></button></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${i}</div></section>`,
    youtubeSection: (title, itemsHTML) => `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>${title}</h2></div></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${itemsHTML}</div></section>`,
    liveTvSection: (i) => `<section class="space-y-4"><div class="section-title-wrapper"><div class="section-title"><span class="accent-bar"></span><h2>Live TV Channels</h2></div></div><div class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-4">${i}</div></section>`,
    searchResultItem: (i) => `<a href="#" data-id="${i.link}" ${i.link.startsWith('liveTV/') && i.streamUrl ? `data-stream-url="${i.streamUrl}"` : ''} class="search-result-item content-link"><img src="${i.posterUrl}" alt="${i.title}" onerror="this.onerror=null;this.src='https://via.placeholder.com/50x75.png?text=N/A';"/><p class="font-semibold">${i.title}</p></a>`,
    skeletonSection: (isThumbnail = false) => { const cardType = isThumbnail ? 'thumbnail' : ''; let cards = ''; for (let i = 0; i < 6; i++) { cards += `<div class="w-36 sm:w-40 flex-shrink-0"><div class="skeleton-card shimmer"><div class="img ${cardType}"></div><div class="title"></div></div></div>`; } return `<section class="space-y-4"><div class="section-title-wrapper"><div class="h-6 w-48 bg-[#2a2a2a] rounded shimmer"></div></div><div class="flex overflow-x-auto gap-4 pb-2 scrollbar-hide -mx-4 px-4">${cards}</div></section>`; }
};
const Player = {
    UI: { playerPageView: document.getElementById('player-page-view'), playerWrapper: document.getElementById('player-wrapper'), movieInfo: document.getElementById('movie-info'), relatedContainer: document.getElementById('related-content-container'), relatedTitle: document.getElementById('related-title'), likeBtn: document.getElementById('like-btn'), dislikeBtn: document.getElementById('dislike-btn'), likeCount: document.getElementById('like-count'), dislikeCount: document.getElementById('dislike-count'), commentBtn: document.getElementById('comment-btn'), commentSection: document.getElementById('comment-section'), closeCommentsBtn: document.getElementById('close-comments-btn'), commentForm: document.getElementById('comment-form'), commentInput: document.getElementById('comment-input'), commentsList: document.getElementById('comments-list'), playerTitleHeader: document.getElementById('player-page-title-header') },
    // পরিবর্তিত কোড: state এ টাচ ইভেন্ট ফাংশনগুলো সংরক্ষণ করা হবে
    state: { movieRef: null, unsubscribe: null, currentVideoElement: null, controlsTimeout: null, hlsInstance: null, isScrubbing: false, playerType: 'movie', touchStartHandler: null, touchMoveHandler: null, touchEndHandler: null },
    init(id) {
        this.cleanupPlayer(); this.state.playerType = id.startsWith('moviesSections/') ? 'movie' : 'live';
        if (id.startsWith('youtube/')) { this.initYouTubeVideo(id.split('/')[1]); return; }
        if (this.state.unsubscribe) this.state.unsubscribe();
        const playerContent = document.createElement('div'); playerContent.className = 'player-content'; this.UI.playerWrapper.appendChild(playerContent);
        const loader = document.createElement('div'); loader.className = 'player-loader'; loader.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; this.UI.playerWrapper.appendChild(loader);
        this.UI.playerWrapper.classList.add('loading'); this.UI.movieInfo.innerHTML = ''; this.UI.relatedContainer.innerHTML = '';
        this.state.movieRef = doc(db, id); let isFirstLoad = true;
        this.state.unsubscribe = onSnapshot(this.state.movieRef, (docSnap) => {
            if (!docSnap.exists()) { this.UI.playerWrapper.classList.remove('loading'); playerContent.innerHTML = `<p class="text-center p-4">Content not available.</p>`; return; }
            const content = docSnap.data();
            if (isFirstLoad) {
                this.createPlayer(content.videoUrl || content.streamUrl, content.posterUrl || content.logoUrl, this.state.playerType);
                this.UI.playerTitleHeader.textContent = content.title || content.name;
                this.UI.movieInfo.innerHTML = `<h1 class="text-2xl md:text-3xl font-bold mb-2">${content.title||content.name}</h1><p class="text-gray-300">${content.description||''}</p>`;
                this.loadRelatedContent(id); this.setupActionHandlers(id); this.setupCommentSection(id); isFirstLoad = false;
            }
            this.UI.likeCount.textContent = content.likes || 0; this.UI.dislikeCount.textContent = content.dislikes || 0; this.updateActionButtonsUI(id);
        });
    },
    async initYouTubeVideo(videoId) {
        this.state.playerType = 'live'; const playerContent = document.createElement('div'); playerContent.className = 'player-content'; this.UI.playerWrapper.appendChild(playerContent);
        try {
            const response = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${YOUTUBE_API_KEY}`);
            const data = await response.json();
            if (data.items && data.items.length > 0) {
                const videoInfo = data.items[0].snippet;
                this.createPlayer(`https://www.youtube.com/embed/${videoId}?autoplay=1`, videoInfo.thumbnails.high.url, 'youtube');
                this.UI.playerTitleHeader.textContent = videoInfo.title;
                this.UI.movieInfo.innerHTML = `<h1 class="text-2xl md:text-3xl font-bold mb-2">${videoInfo.title}</h1><p class="text-gray-300">${videoInfo.description.replace(/\n/g, '<br>')}</p>`;
                document.getElementById('action-bar').style.display = 'none'; document.getElementById('related-content').style.display = 'none';
            } else { playerContent.innerHTML = `<p class="text-center p-4">YouTube video not found.</p>`; }
        } catch (error) { console.error("YouTube error:", error); playerContent.innerHTML = `<p class="text-center p-4">Could not load YouTube video.</p>`; }
    },
    createPlayer(videoUrl, posterUrl, playerType) {
        const playerContent = this.UI.playerWrapper.querySelector('.player-content'); if (!playerContent) return;
        const lowerCaseUrl = videoUrl ? videoUrl.toLowerCase() : '';
        const isIframe = lowerCaseUrl.includes('bongobd.com') || lowerCaseUrl.includes('youtube.com/embed');
        const isDirectVideo = !isIframe && (lowerCaseUrl.endsWith('.m3u8') || ['.mp4', '.mkv', '.webm'].some(ext => lowerCaseUrl.includes(ext)));
        if (isDirectVideo && videoUrl) {
            playerContent.innerHTML = `<video id="video-player" poster="${posterUrl}" playsinline class="bg-black"></video>`;
            const video = document.getElementById('video-player'); this.state.currentVideoElement = video;
            if (lowerCaseUrl.endsWith('.m3u8')) {
                if (Hls.isSupported()) { this.state.hlsInstance = new Hls(); this.state.hlsInstance.loadSource(videoUrl); this.state.hlsInstance.attachMedia(video); }
                else if (video.canPlayType('application/vnd.apple.mpegurl')) { video.src = videoUrl; }
            } else { video.src = videoUrl; }
            if (playerType === 'movie') this.setupMovieControls(video); else this.setupLiveTvControls(video);
        } else if (videoUrl) {
            this.UI.playerWrapper.classList.remove('loading'); playerContent.innerHTML = `<iframe src="${videoUrl}" frameborder="0" allow="autoplay; fullscreen; encrypted-media" allowfullscreen></iframe>`;
            this.addRotatedViewButtons(); this.state.currentVideoElement = null;
        } else { this.UI.playerWrapper.classList.remove('loading'); playerContent.innerHTML = `<p class="text-center p-4">No video source found.</p>`; }
    },
    setupLiveTvControls(video) {
        this.UI.playerWrapper.insertAdjacentHTML('afterbegin', `<div id="volume-indicator-v" class="vertical-indicator"><i class="fas fa-volume-up"></i><div class="indicator-bar-container"><div class="indicator-bar-level"></div></div></div><div id="brightness-indicator-v" class="vertical-indicator"><i class="fas fa-sun"></i><div class="indicator-bar-container"><div class="indicator-bar-level"></div></div></div>`);
        const closeBtn = document.createElement('button'); closeBtn.className = 'view-mode-btn close-rotated-view-btn'; closeBtn.innerHTML = `<img src="${PlayerIcons.exitFullscreen}" alt="Exit Fullscreen" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">`; closeBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
        const controlsHTML = `
            <div id="custom-controls-overlay" class="visible"><button id="custom-play-pause-btn"><img src="${PlayerIcons.play}" alt="Play"></button></div>
            <div id="settings-panel"><button class="resolution-option">1080p</button><button class="resolution-option">720p</button><button class="resolution-option">480p</button><button class="resolution-option">Auto</button></div>
            <div id="player-controls-container-live"> <span class="live-indicator">LIVE</span>
                <div class="live-controls-right">
                    <button id="fit-screen-btn" class="player-control-btn"><img src="${PlayerIcons.fitScreen}" alt="Fit Screen"></button>
                    <button id="settings-btn" class="player-control-btn"><img src="${PlayerIcons.settings}" alt="Settings"></button>
                    <button class="enter-rotated-view-btn player-control-btn"><img src="${PlayerIcons.fullscreen}" alt="Fullscreen"></button>
                </div>
            </div>`;
        this.UI.playerWrapper.appendChild(closeBtn); this.UI.playerWrapper.insertAdjacentHTML('beforeend', controlsHTML);
        const centerPlayPauseBtn = document.getElementById('custom-play-pause-btn'), rotateBtn = this.UI.playerWrapper.querySelector('.enter-rotated-view-btn'), settingsBtn = document.getElementById('settings-btn'), settingsPanel = document.getElementById('settings-panel'), fitScreenBtn = document.getElementById('fit-screen-btn');
        const togglePlay = () => video.paused ? video.play() : video.pause();
        video.addEventListener('play', () => { centerPlayPauseBtn.innerHTML = `<img src="${PlayerIcons.pause}" alt="Pause">`; document.getElementById('custom-controls-overlay').classList.remove('visible'); });
        video.addEventListener('pause', () => { centerPlayPauseBtn.innerHTML = `<img src="${PlayerIcons.play}" alt="Play">`; document.getElementById('custom-controls-overlay').classList.add('visible'); });
        video.addEventListener('waiting', () => this.UI.playerWrapper.classList.add('loading'));
        video.addEventListener('playing', () => this.UI.playerWrapper.classList.remove('loading'));
        video.addEventListener('canplay', () => { this.UI.playerWrapper.classList.remove('loading'); video.play().catch(() => document.getElementById('custom-controls-overlay').classList.add('visible')); });
        centerPlayPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
        rotateBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
        settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); settingsPanel.classList.toggle('visible'); });
        fitScreenBtn.onclick = (e) => { e.stopPropagation(); video.classList.toggle('video-fit-cover'); };
        this.addTouchGestures(video);
    },
    setupMovieControls(video) {
        this.UI.playerWrapper.insertAdjacentHTML('afterbegin', `<div id="volume-indicator-v" class="vertical-indicator"><i class="fas fa-volume-up"></i><div class="indicator-bar-container"><div class="indicator-bar-level"></div></div></div><div id="brightness-indicator-v" class="vertical-indicator"><i class="fas fa-sun"></i><div class="indicator-bar-container"><div class="indicator-bar-level"></div></div></div>`);
        const closeBtn = document.createElement('button'); closeBtn.className = 'view-mode-btn close-rotated-view-btn'; closeBtn.innerHTML = `<img src="${PlayerIcons.exitFullscreen}" alt="Exit Fullscreen" style="width: 20px; height: 20px; filter: brightness(0) invert(1);">`; closeBtn.onclick = (e) => { e.stopPropagation(); this.toggleRotateView(); };
        const controlsHTML = `
            <div id="double-tap-overlay"><div class="tap-zone" id="tap-rewind"></div><div class="tap-zone" id="tap-forward"></div></div>
            <div id="custom-controls-overlay" class="visible"><button id="custom-play-pause-btn"><img src="${PlayerIcons.play}" alt="Play"></button></div>
            <div id="player-controls-container">
                <div id="progress-container"> <div id="progress-bar-wrapper"> <div id="progress-buffered"></div> <div id="progress-played"></div> <input type="range" id="progress-bar" value="0" min="0" step="1"> </div> </div>
                <div class="controls-bottom-bar">
                    <div class="controls-left"> <button id="play-pause-btn" class="player-control-btn"><img src="${PlayerIcons.play}" alt="Play"></button> <span id="time-display">00:00 / 00:00</span> </div>
                    <div class="controls-right"> <button id="fit-screen-btn" class="player-control-btn"><img src="${PlayerIcons.fitScreen}" alt="Fit Screen"></button> <button class="enter-rotated-view-btn player-control-btn"><img src="${PlayerIcons.fullscreen}" alt="Fullscreen"></button> </div>
                </div>
            </div>`;
        this.UI.playerWrapper.appendChild(closeBtn); this.UI.playerWrapper.insertAdjacentHTML('beforeend', controlsHTML);
        const centerPlayPauseBtn = document.getElementById('custom-play-pause-btn'), playPauseBtn = document.getElementById('play-pause-btn'), progressBar = document.getElementById('progress-bar'), progressBuffered = document.getElementById('progress-buffered'), progressPlayed = document.getElementById('progress-played'), timeDisplay = document.getElementById('time-display'), rotateBtn = this.UI.playerWrapper.querySelector('.enter-rotated-view-btn'), fitScreenBtn = document.getElementById('fit-screen-btn'), tapRewind = document.getElementById('tap-rewind'), tapForward = document.getElementById('tap-forward');
        const formatTime = (t) => { if(isNaN(t)) return '00:00'; const s=Math.floor(t%60),m=Math.floor(t/60)%60,h=Math.floor(t/3600); return h>0?`${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`:`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`};
        const togglePlay = () => video.paused ? video.play() : video.pause();
        video.addEventListener('play', () => { playPauseBtn.innerHTML = `<img src="${PlayerIcons.pause}" alt="Pause">`; centerPlayPauseBtn.innerHTML = `<img src="${PlayerIcons.pause}" alt="Pause">`; document.getElementById('custom-controls-overlay').classList.remove('visible'); });
        video.addEventListener('pause', () => { playPauseBtn.innerHTML = `<img src="${PlayerIcons.play}" alt="Play">`; centerPlayPauseBtn.innerHTML = `<img src="${PlayerIcons.play}" alt="Play">`; document.getElementById('custom-controls-overlay').classList.add('visible'); });
        video.addEventListener('waiting', () => this.UI.playerWrapper.classList.add('loading')); video.addEventListener('playing', () => this.UI.playerWrapper.classList.remove('loading'));
        video.addEventListener('canplay', () => { this.UI.playerWrapper.classList.remove('loading'); video.play().catch(() => document.getElementById('custom-controls-overlay').classList.add('visible')); });
        video.addEventListener('loadedmetadata', () => { progressBar.max = video.duration; timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`; });
        video.addEventListener('timeupdate', () => { if (!this.state.isScrubbing) { progressBar.value = video.currentTime; progressPlayed.style.width = `${(video.currentTime / video.duration) * 100}%`; } timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`; });
        video.addEventListener('progress', () => { if (video.buffered.length > 0) { progressBuffered.style.width = `${(video.buffered.end(video.buffered.length - 1) / video.duration) * 100}%`; }});
        playPauseBtn.onclick = centerPlayPauseBtn.onclick = rotateBtn.onclick = fitScreenBtn.onclick = (e) => { e.stopPropagation(); if (e.currentTarget === playPauseBtn || e.currentTarget === centerPlayPauseBtn) togglePlay(); else if (e.currentTarget === rotateBtn) this.toggleRotateView(); else if (e.currentTarget === fitScreenBtn) video.classList.toggle('video-fit-cover'); };
        progressBar.addEventListener('mousedown', () => this.state.isScrubbing = true ); progressBar.addEventListener('mouseup', () => this.state.isScrubbing = false );
        progressBar.addEventListener('input', (e) => { const newTime = e.target.value; progressPlayed.style.width = `${(newTime / video.duration) * 100}%`; timeDisplay.textContent = `${formatTime(newTime)} / ${formatTime(video.duration)}`; });
        progressBar.addEventListener('change', () => video.currentTime = progressBar.value );
        const handleDoubleTap = (e) => { if (Date.now() - (this.state.lastTap || 0) < 300) { video.currentTime += (e.currentTarget.id === 'tap-forward' ? 10 : -10); this.state.lastTap = 0; } else { this.state.lastTap = Date.now(); }};
        tapRewind.addEventListener('click', handleDoubleTap); tapForward.addEventListener('click', handleDoubleTap);
        video.addEventListener('ended', () => { if (localStorage.getItem('autoplayNext') === 'true') { const nextLink = Player.UI.relatedContainer.querySelector('.content-link'); if (nextLink?.dataset.id) App.showPlayerPage(nextLink.dataset.id); } });
        this.addTouchGestures(video);
    },
    addTouchGestures(video) {
        const pWrap = this.UI.playerWrapper, volInd = document.getElementById('volume-indicator-v'), volLvl = volInd?.querySelector('.indicator-bar-level'), brtInd = document.getElementById('brightness-indicator-v'), brtLvl = brtInd?.querySelector('.indicator-bar-level');
        let sY=0,sX=0,isDrag=false,indTimeout,isTap=true;
        const showInd=(i,l,v)=>{if(!i||!l)return;l.style.height=`${v*100}%`;i.classList.add('visible');clearTimeout(indTimeout);indTimeout=setTimeout(()=>i.classList.remove('visible'),1500)};
        
        // পরিবর্তিত কোড: ইভেন্ট হ্যান্ডলার ফাংশনগুলোকে state এ সংরক্ষণ করা হচ্ছে
        this.state.touchStartHandler = (e) => { if(e.touches.length===1){const t=e.touches[0];sY=t.clientY;sX=t.clientX;isDrag=false;isTap=true}};
        this.state.touchMoveHandler = (e) => {if(e.touches.length!==1||e.target.closest('#player-controls-container,#player-controls-container-live'))return;const t=e.touches[0];if(isTap&&(Math.abs(t.clientX-sX)>10||Math.abs(t.clientY-sY)>10)){isTap=false}if(isTap)return;isDrag=true;e.preventDefault();const r=pWrap.getBoundingClientRect();let dY=sY-t.clientY;if(pWrap.classList.contains('rotated-view')){dY=-(sX-t.clientX)}if(sX<r.width/2){let cB=parseFloat(pWrap.style.filter?.replace('brightness(','').replace(')',''))||1;cB=Math.max(.2,Math.min(1.5,cB+dY/200));pWrap.style.filter=`brightness(${cB})`;showInd(brtInd,brtLvl,(cB-.2)/1.3)}else{video.volume=Math.max(0,Math.min(1,video.volume+dY/200));showInd(volInd,volLvl,video.volume)}sY=t.clientY;sX=t.clientX};
        this.state.touchEndHandler = (e) => {
            if(isTap && !isDrag && !e.target.closest('button, input')) {
                const vis=pWrap.classList.toggle('controls-visible');
                if(video.paused && vis){ document.getElementById('custom-controls-overlay')?.classList.add('visible') }
                else { document.getElementById('custom-controls-overlay')?.classList.remove('visible') }
                if(vis){
                    clearTimeout(this.state.controlsTimeout);
                    if(!video.paused){
                        this.state.controlsTimeout = setTimeout(() => {
                            pWrap.classList.remove('controls-visible');
                            document.getElementById('custom-controls-overlay')?.classList.remove('visible');
                        }, 3000)
                    }
                }
            }
            isDrag=false;
            clearTimeout(indTimeout);
            indTimeout=setTimeout(()=>{volInd?.classList.remove('visible');brtInd?.classList.remove('visible')},500)
        };

        pWrap.addEventListener('touchstart', this.state.touchStartHandler, {passive:true});
        pWrap.addEventListener('touchmove', this.state.touchMoveHandler, {passive:false});
        pWrap.addEventListener('touchend', this.state.touchEndHandler);
        video.addEventListener('volumechange',()=>{if(volLvl)volLvl.style.height=`${video.volume*100}%`});
    },
    addRotatedViewButtons() {
        const closeBtn=document.createElement('button');closeBtn.className='view-mode-btn close-rotated-view-btn';closeBtn.innerHTML=`<img src="${PlayerIcons.exitFullscreen}" alt="Exit Fullscreen" style="width:20px;height:20px;filter:brightness(0) invert(1);">`;closeBtn.onclick=(e)=>{e.stopPropagation();this.toggleRotateView()};
        const enterBtn=document.createElement('button');enterBtn.className='view-mode-btn enter-rotated-view-btn';enterBtn.innerHTML=`<img src="${PlayerIcons.fullscreen}" alt="Fullscreen" style="width:20px;height:20px;filter:brightness(0) invert(1);">`;enterBtn.onclick=(e)=>{e.stopPropagation();this.toggleRotateView()};
        this.UI.playerWrapper.appendChild(closeBtn);this.UI.playerWrapper.appendChild(enterBtn);
    },
    toggleRotateView() { const isRotated = this.UI.playerWrapper.classList.toggle('rotated-view'); document.body.style.overflow = isRotated ? 'hidden' : ''; },
    cleanupPlayer() {
        // পরিবর্তিত কোড: পুরোনো টাচ ইভেন্ট লিসেনারগুলো ডিলিট করা হচ্ছে
        if (this.state.touchStartHandler) {
            this.UI.playerWrapper.removeEventListener('touchstart', this.state.touchStartHandler);
            this.state.touchStartHandler = null;
        }
        if (this.state.touchMoveHandler) {
            this.UI.playerWrapper.removeEventListener('touchmove', this.state.touchMoveHandler);
            this.state.touchMoveHandler = null;
        }
        if (this.state.touchEndHandler) {
            this.UI.playerWrapper.removeEventListener('touchend', this.state.touchEndHandler);
            this.state.touchEndHandler = null;
        }

        if(this.state.hlsInstance){this.state.hlsInstance.destroy();this.state.hlsInstance=null}
        if(this.state.currentVideoElement){this.state.currentVideoElement.pause();this.state.currentVideoElement.src='';this.state.currentVideoElement.load()}
        this.UI.playerWrapper.innerHTML='';
        this.UI.playerWrapper.className='relative w-full bg-black';
        this.UI.playerWrapper.style.filter='';
        clearTimeout(this.state.controlsTimeout);
        document.body.style.overflow='';
        document.getElementById('action-bar').style.display='flex';
        document.getElementById('related-content').style.display='block';
    },
    destroyPlayer() { this.cleanupPlayer(); if (this.state.unsubscribe) { this.state.unsubscribe(); this.state.unsubscribe = null; } },
    async loadRelatedContent(path) { this.UI.relatedContainer.innerHTML='';const cId=path.split('/').pop(),isLive=path.startsWith('liveTV');this.UI.relatedTitle.textContent=isLive?'Other Channels':'You may also like';const colPath=isLive?'liveTV':path.substring(0,path.lastIndexOf('/'));const q=query(collection(db,colPath),where("__name__","!=",cId),limit(10));const snap=await getDocs(q);snap.forEach(d=>{const con=d.data(),card=document.createElement('div'),tClass=isLive?'is-logo':'is-poster';card.className=`flex-shrink-0 player-related-card ${tClass}`;card.innerHTML=`<a href="#" data-id="${colPath}/${d.id}" class="content-link block group"><div class="image-container"><img alt="${con.title||con.name}" src="${con.posterUrl||con.logoUrl}" loading="lazy" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"/></div><p class="text-gray-300 text-sm mt-1.5 truncate ${isLive?'w-24 text-center':'w-36'} group-hover:text-[var(--primary-color)] transition-colors">${con.title||con.name}</p></a>`;this.UI.relatedContainer.appendChild(card)})},
    setupActionHandlers(p){const k=`action_${p.replace(/\//g,'_')}`;this.UI.likeBtn.onclick=()=>this.handleVote('likes',k);this.UI.dislikeBtn.onclick=()=>this.handleVote('dislikes',k)},async handleVote(t,k){const c=localStorage.getItem(k),o=t==='likes'?'dislikes':'likes';let u={};c===t?(u[t]=increment(-1),localStorage.removeItem(k)):(u[t]=increment(1),c&&(u[o]=increment(-1)),localStorage.setItem(k,t));await updateDoc(this.state.movieRef,u)},updateActionButtonsUI(p){const k=`action_${p.replace(/\//g,'_')}`,v=localStorage.getItem(k);this.UI.likeBtn.classList.toggle('active',v==='likes');this.UI.dislikeBtn.classList.toggle('active',v==='dislikes')},setupCommentSection(p){const c=collection(db,`${p}/comments`);this.UI.commentBtn.onclick=()=>this.UI.commentSection.classList.add('open');this.UI.closeCommentsBtn.onclick=()=>this.UI.commentSection.classList.remove('open');this.UI.commentForm.onsubmit=async e=>{e.preventDefault();const t=this.UI.commentInput.value.trim();if(t){await addDoc(c,{text:t,author:"User",createdAt:serverTimestamp()});this.UI.commentInput.value=''}};this.listenForComments(c)},listenForComments(r){onSnapshot(query(r,orderBy('createdAt','desc')),s=>{this.UI.commentsList.innerHTML='';s.forEach(d=>{const c=d.data(),a=c.createdAt?.toDate().toLocaleString()||'',e=document.createElement('div');e.className='border-b border-gray-700 py-3';e.innerHTML=`<div class="flex items-start space-x-3"><i class="fas fa-user-circle text-2xl text-gray-400"></i><div><p class="font-semibold">${c.author} <span class="text-xs text-gray-500 ml-2">${a}</span></p><p class="text-gray-300 break-words">${c.text}</p></div></div>`;this.UI.commentsList.appendChild(e)})})}
};

const Drawer = { drawer:null,overlay:null,openBtn:null,body:null,autoplayToggle:null,init(){this.drawer=document.getElementById('nav-drawer');this.overlay=document.getElementById('drawer-overlay');this.openBtn=document.getElementById('drawer-open-btn');this.autoplayToggle=document.getElementById('autoplay-toggle');this.body=document.body;if(!this.drawer||!this.overlay||!this.openBtn)return;this.openBtn.addEventListener('click',this.open.bind(this));this.overlay.addEventListener('click',this.close.bind(this));this.setupSwipeToClose();this.setupAutoplayToggle()},open(){this.body.classList.add('drawer-open')},close(){this.body.classList.remove('drawer-open')},setupAutoplayToggle(){const e=localStorage.getItem('autoplayNext')==='true';this.autoplayToggle.checked=e;this.autoplayToggle.addEventListener('change',e=>{localStorage.setItem('autoplayNext',e.target.checked)})},setupSwipeToClose(){let t=0,c=0;const o=this.drawer.offsetWidth;this.drawer.addEventListener('touchstart',e=>{t=e.touches[0].clientX;c=t},{passive:!0});this.drawer.addEventListener('touchmove',e=>{c=e.touches[0].clientX;const n=c-t;if(n<0){this.drawer.style.transition='none';this.drawer.style.transform=`translateX(${n}px)`}},{passive:!0});this.drawer.addEventListener('touchend',()=>{this.drawer.style.transition='transform 0.3s ease-in-out';const e=c-t;if(e<-(o*0.25)){this.close()}this.drawer.style.transform=''})}};

function parseISO8601Duration(duration) {
    const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
    if (!match) return "00:00";
    const hours = (parseInt(match[1]) || 0), minutes = (parseInt(match[2]) || 0), seconds = (parseInt(match[3]) || 0);
    return hours > 0 ? `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}` : `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

const App = {
    contentCache: {}, allContent: [], youtubeSectionState: {},
    UI: { ...UI, searchBackBtn: document.getElementById('search-back-btn'), searchClearBtn: document.getElementById('search-clear-btn'), voiceSearchBtn: document.getElementById('voice-search-btn'), topSearchesContainer: document.getElementById('top-searches-container'), topSearchesPills: document.getElementById('top-searches-pills'), searchResultsList: document.getElementById('search-results-list'), searchNoResults: document.getElementById('search-no-results') },
    topSearches: ["T SPORTS", "Taandob", "Borbaad", "Saiyaara", "Disney"],
    async fetchYouTubeSection(sectionId, title, searchConfig, isLoadMore = false) {
        if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY === "YOUR_YOUTUBE_API_KEY") { return isLoadMore ? { html: '', hasMore: false } : ''; }
        if (!this.youtubeSectionState[sectionId]) { this.youtubeSectionState[sectionId] = { nextPageToken: null, loadedVideoIds: new Set() }; }
        const state = this.youtubeSectionState[sectionId];
        let searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(searchConfig.query)}&type=video&order=date&maxResults=${searchConfig.maxResults || 25}&key=${YOUTUBE_API_KEY}`;
        if (state.nextPageToken && isLoadMore) searchUrl += `&pageToken=${state.nextPageToken}`;
        if (searchConfig.onlyLatest) { const date = new Date(); date.setDate(date.getDate() - 60); searchUrl += `&publishedAfter=${date.toISOString()}`; }
        if (searchConfig.duration) searchUrl += `&videoDuration=${searchConfig.duration}`;
        try {
            const searchResponse = await fetch(searchUrl);
            if (searchResponse.status === 403) { console.error("YouTube API Quota Exceeded."); return isLoadMore ? { html: '', hasMore: false } : Render.youtubeSection(title, `<p class="p-4 text-center text-gray-500">Could not load videos.</p>`); }
            const searchData = await searchResponse.json(); state.nextPageToken = searchData.nextPageToken;
            if (!searchData.items || searchData.items.length === 0) return isLoadMore ? { html: '', hasMore: false } : '';
            const newVideoIds = searchData.items.map(item => item.id.videoId).filter(id => !state.loadedVideoIds.has(id));
            if (newVideoIds.length === 0) return isLoadMore ? { html: '', hasMore: false } : '';
            const detailsResponse = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${newVideoIds.join(',')}&key=${YOUTUBE_API_KEY}`);
            const detailsData = await detailsResponse.json(); if (!detailsData.items) return isLoadMore ? { html: '', hasMore: false } : '';
            const durationMap = {}; detailsData.items.forEach(item => { durationMap[item.id] = parseISO8601Duration(item.contentDetails.duration); });
            const addedTitles = new Set();
            const itemsHTML = detailsData.items.map(item => {
                const simplifiedTitle = item.snippet.title.toLowerCase().replace(/(official trailer|trailer|teaser|hd|4k|\|)/g, '').trim();
                if (addedTitles.has(simplifiedTitle)) return '';
                state.loadedVideoIds.add(item.id); addedTitles.add(simplifiedTitle);
                const videoData = { title: item.snippet.title, posterUrl: item.snippet.thumbnails.high.url, link: `youtube/${item.id}`, duration: durationMap[item.id] || "00:00" };
                this.allContent.push(videoData);
                return Render.card(videoData, searchConfig.cardType);
            }).join('');
            if (isLoadMore) return { html: itemsHTML, hasMore: !!state.nextPageToken };
            const loadMoreBtn = state.nextPageToken ? `<div class="w-40 flex-shrink-0 flex items-center justify-center"><button class="load-more-yt-btn p-4 bg-gray-800 rounded-lg hover:bg-gray-700" data-section-id="${sectionId}"><i class="fas fa-plus mr-2"></i> More</button></div>` : '';
            return Render.youtubeSection(title, itemsHTML + loadMoreBtn);
        } catch (error) { console.error(`Error fetching YouTube for "${title}":`, error); return ''; }
    },
    setupEventListeners() {
      document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => App.switchPage(b.dataset.target)));
      document.getElementById('search-open-btn').addEventListener('click', App.openSearch);
      this.UI.searchBackBtn.addEventListener('click', App.closeSearch);
      this.UI.searchClearBtn.addEventListener('click', App.clearSearchInput);
      this.UI.voiceSearchBtn.addEventListener('click', App.startVoiceSearch);
      document.body.addEventListener('click', async (e) => {
        const contentLink = e.target.closest('.content-link');
if (contentLink) {
    e.preventDefault();
    let clickedId = contentLink.dataset.id; // প্রথমে data-id থেকে মান নিন

    // যদি data-id তে কোনো মান থাকে, তাহলেই কেবল কাজ হবে
    if (clickedId) {
        // চেক করুন এটি কি একটি পাথ (যাতে '/' আছে) নাকি শুধু একটি টাইটেল
        if (!clickedId.includes('/')) {
            // যদি শুধু টাইটেল হয়, তাহলে আমাদের সব কনটেন্টের তালিকা থেকে খুঁজুন
            const foundContent = App.allContent.find(item =>
                (item.title || item.name || '').toLowerCase() === clickedId.toLowerCase()
            );

            if (foundContent) {
                // যদি পাওয়া যায়, তাহলে আসল লিংকটি ব্যবহার করুন
                clickedId = foundContent.link;
            } else {
                // যদি খুঁজে না পাওয়া যায়, তাহলে একটি সতর্কবার্তা দিন এবং লিংকটি null করুন
                console.warn(`Content with title "${clickedId}" not found in allContent list.`);
                clickedId = null;
            }
        }
        
        // যদি সবশেষে একটি বৈধ লিংক থাকে, তাহলে প্লেয়ার পেজ দেখান
        if (clickedId) {
            App.closeSearch();
            App.showPlayerPage(clickedId);
        }
    }
    return; // এই ব্লকের কাজ শেষ
}
        const seeMoreBtn = e.target.closest('.see-more-btn'); if (seeMoreBtn) { if (seeMoreBtn.dataset.type === 'livetv-redirect') App.switchPage('livetv-page'); else App.showGridView(seeMoreBtn.dataset.title, seeMoreBtn.dataset.type, seeMoreBtn.dataset.sectionId); }
        const topSearchPill = e.target.closest('.top-search-pill'); if (topSearchPill) { this.UI.searchInput.value = topSearchPill.dataset.query; this.UI.searchInput.dispatchEvent(new Event('input', { bubbles: true })); }
        const loadMoreBtn = e.target.closest('.load-more-yt-btn');
        if (loadMoreBtn) {
            loadMoreBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`; loadMoreBtn.disabled = true;
            const sectionId = loadMoreBtn.dataset.sectionId, section = App.youtubeSectionConfigs[sectionId];
            if (section) {
                const result = await App.fetchYouTubeSection(sectionId, section.title, section.config, true);
                const container = loadMoreBtn.parentElement.parentElement;
                loadMoreBtn.parentElement.remove(); container.insertAdjacentHTML('beforeend', result.html);
                if (result.hasMore) { container.insertAdjacentHTML('beforeend', `<div class="w-40 flex-shrink-0 flex items-center justify-center"><button class="load-more-yt-btn p-4 bg-gray-800 rounded-lg" data-section-id="${sectionId}"><i class="fas fa-plus mr-2"></i> More</button></div>`); }
            }
        }
      });
      document.getElementById('grid-back-btn').addEventListener('click', () => { UI.gridPageView.style.display = 'none'; });
      document.getElementById('player-back-btn').addEventListener('click', App.hidePlayerPage);
      this.UI.searchInput.addEventListener('input', () => App.handleSearch());
    },
    openSearch(){document.body.classList.add('search-overlay-active');this.UI.searchInput.focus();this.handleSearch()},closeSearch(){document.body.classList.remove('search-overlay-active');this.clearSearchInput()},clearSearchInput(){this.UI.searchInput.value='';this.UI.searchInput.dispatchEvent(new Event('input',{bubbles:true}))},handleSearch(){const q=this.UI.searchInput.value.toLowerCase().trim();const h=q.length>0;this.UI.searchClearBtn.classList.toggle('hidden',!h);this.UI.topSearchesContainer.classList.toggle('hidden',h);this.UI.searchResultsList.classList.toggle('hidden',!h);this.UI.searchNoResults.classList.add('hidden');if(!h){this.UI.searchResultsList.innerHTML='';return}const r=this.allContent.filter(i=>(i.title||i.name||'').toLowerCase().includes(q));if(r.length>0){this.UI.searchResultsList.innerHTML=r.map(Render.searchResultItem).join('')}else{this.UI.searchResultsList.innerHTML='';this.UI.searchNoResults.classList.remove('hidden');this.UI.searchNoResults.textContent=`No results for "${q}"`}},startVoiceSearch(){const R=window.SpeechRecognition||window.webkitSpeechRecognition;if(!R){alert("Voice search not supported.");return}const r=new R();r.lang='en-US';const m=this.UI.voiceSearchBtn;m.classList.add('recording');r.onresult=e=>{this.UI.searchInput.value=e.results[0][0].transcript;this.UI.searchInput.dispatchEvent(new Event('input',{bubbles:true}))};r.onend=()=>{m.classList.remove('recording')};r.onerror=e=>{console.error('Voice search error:',e.error);m.classList.remove('recording')};r.start()},renderTopSearches(){this.UI.topSearchesPills.innerHTML=this.topSearches.map(t=>`<button class="top-search-pill" data-query="${t}"><i class="fas fa-search text-xs opacity-70"></i><span>${t}</span></button>`).join('')},
    showPlayerPage(id) { UI.appShell.style.display = 'none'; UI.gridPageView.style.display = 'none'; UI.playerPageView.style.display = 'block'; UI.adContainer.style.display = 'none'; UI.bottomNav.style.display = 'none'; window.scrollTo(0, 0); Player.init(id); },
    hidePlayerPage() { Player.destroyPlayer(); UI.appShell.style.display = 'flex'; UI.playerPageView.style.display = 'none'; UI.adContainer.style.display = 'flex'; UI.bottomNav.style.display = 'flex'; },
    switchPage(id) {
        document.querySelectorAll('.nav-button').forEach(b => b.classList.toggle('active', b.dataset.target === id));
        UI.pages.forEach(p => p.classList.toggle('active', p.id === id)); window.scrollTo(0, 0);
        const config = { 'home-page': { title: 'Home', icon: 'fas fa-home' }, 'livetv-page': { title: 'Live TV', icon: 'fas fa-tv' }, 'cricket-page': { title: 'Sports', icon: 'fas fa-basketball-ball' }, 'movies-page': { title: 'Movies', icon: 'fas fa-clapperboard' } }[id] || { title: 'Ti Sports', icon: 'fas fa-play-circle' };
        UI.pageTitleHeader.classList.add('opacity-0'); UI.pageTitleIcon.classList.add('opacity-0', 'transform', 'scale-50');
        setTimeout(() => { UI.pageTitleHeader.textContent = config.title; UI.pageTitleIcon.className = `${config.icon} text-2xl`; UI.pageTitleIcon.style.color = 'var(--primary-color)'; UI.pageTitleHeader.classList.remove('opacity-0'); UI.pageTitleIcon.classList.remove('opacity-0', 'scale-50'); }, 150);
    },
    async showGridView(title, type, sectionId) { UI.gridPageTitle.textContent = title; const cardType = type === 'cricket' ? 'thumbnail' : 'poster'; UI.gridPageContent.innerHTML = Array(12).fill(`<div class="w-full skeleton-card shimmer"><div class="img ${cardType==='thumbnail'?'thumbnail':''}"></div><div class="title"></div></div>`).join(''); UI.gridPageView.style.display = 'block'; const q = query(collection(db, `${type}Sections/${sectionId}/items`), orderBy("order", "asc")); const snapshot = await getDocs(q); UI.gridPageContent.innerHTML = snapshot.docs.map(doc => Render.card({ ...doc.data(), link: `${type}Sections/${sectionId}/items/${doc.id}` }, cardType, true)).join(''); },
    renderSkeletons() { UI.bannerContainer.innerHTML = `<div class="shimmer w-full h-full"></div>`; document.getElementById('home-sections-container').innerHTML = Render.skeletonSection() + Render.skeletonSection(true) + Render.skeletonSection(); },
    async fetchAllContent() {
        this.renderSkeletons();
        this.youtubeSectionConfigs = {
            'yt-sports': { title: 'Latest Sports Updates', config: { query: '"Cricket News" "খেলাযোগ" | "T Sports News" | BDCricTime | "Rabbithole BD Sports"', cardType: 'thumbnail', duration: 'short', onlyLatest: true } },
            'yt-trailers': { title: 'Latest Movie Trailers', config: { query: '("Official Trailer"|"Official Teaser") ("Bangladeshi Movie"|"Hoichoi"|"Chorki"|"Prime Video"|"Netflix"|"Bengali Movie") 2024 2025 -reaction -review', cardType: 'thumbnail', duration: 'medium' } }
        };
        const [ytSportsHtml, ytMoviesHtml, bannerSnapshot, tvSnapshot] = await Promise.all([
            this.fetchYouTubeSection('yt-sports', this.youtubeSectionConfigs['yt-sports'].title, this.youtubeSectionConfigs['yt-sports'].config),
            this.fetchYouTubeSection('yt-trailers', this.youtubeSectionConfigs['yt-trailers'].title, this.youtubeSectionConfigs['yt-trailers'].config),
            getDocs(query(collection(db, "banners"), orderBy("order"))),
            getDocs(query(collection(db, "liveTV"), orderBy("order")))
        ]);
        if (!bannerSnapshot.empty) {
            UI.bannerContainer.innerHTML = `<div class="swiper h-full"><div id="banner-wrapper" class="swiper-wrapper"></div><div class="swiper-pagination"></div></div>`;
            document.getElementById('banner-wrapper').innerHTML = bannerSnapshot.docs.map(doc => `<div class="swiper-slide"><a href="#" data-id="${doc.data().link || doc.data().title || ''}" class="content-link"><img src="${doc.data().posterUrl}" alt="${doc.data().title||''}" loading="eager"/><div class="banner-play-icon"><i class="fas fa-play"></i></div></a></div>`).join('');
            new Swiper('#banner-container .swiper', { loop: true, autoplay: { delay: 3500 }, pagination: { el: '.swiper-pagination', clickable: true } });
        } else { UI.bannerContainer.style.display = 'none'; }
        
        const tvGridItems = tvSnapshot.docs.map(doc => { const item = { id: doc.id, ...doc.data() }; this.allContent.push({ title: item.name, name: item.name, posterUrl: item.logoUrl, link: `liveTV/${item.id}`, streamUrl: item.streamUrl }); return Render.liveTvChannelCard(item); }).join('');
        const tvHorizontalSection = Render.section({ title: 'Live TV' }, tvGridItems, 'livetv-redirect');
        // --- লাইভ টিভি পেজ রেন্ডার করার জন্য নতুন কোড ---
const allTvChannels = tvSnapshot.docs.map(doc => ({
    id: doc.id,
    ...doc.data()
}));
this.renderLiveTvPage(allTvChannels);
        
        let cricketHTML = ytSportsHtml, moviesHTML = ytMoviesHtml;
        for (const type of ['cricket', 'movies']) {
            const sectionsSnapshot = await getDocs(query(collection(db, `${type}Sections`), orderBy("order")));
            for (const sectionDoc of sectionsSnapshot.docs) {
                const sectionData = sectionDoc.data();
                const itemsSnapshot = await getDocs(query(collection(db, `${type}Sections/${sectionDoc.id}/items`), orderBy("order", "asc"), limit(10)));
                if (itemsSnapshot.empty) continue;
                const itemsHTML = itemsSnapshot.docs.map(itemDoc => { const itemData = { ...itemDoc.data(), link: `${type}Sections/${sectionDoc.id}/items/${itemDoc.id}` }; this.allContent.push(itemData); return Render.card(itemData, type === 'cricket' ? 'thumbnail' : 'poster'); }).join('');
                const sectionHTML = Render.section(sectionData, itemsHTML, type, sectionDoc.id);
                if(type === 'cricket') cricketHTML += sectionHTML; else if(type === 'movies') moviesHTML += sectionHTML;
            }
        }
        
        let homeHTML = tvHorizontalSection + cricketHTML + moviesHTML;
        document.getElementById('home-sections-container').innerHTML = homeHTML;
        document.getElementById('cricket-page').innerHTML = cricketHTML;
        document.getElementById('movies-page').innerHTML = moviesHTML;
    },
// App অবজেক্টের ভেতরে এই নতুন ফাংশনটি যোগ করুন
renderLiveTvPage(channels) {
    const categoryBar = document.getElementById('livetv-category-bar');
    const gridContainer = document.getElementById('livetv-grid-container');

    if (!categoryBar || !gridContainer) return;

    // চ্যানেল ডেটা থেকে ইউনিক ক্যাটাগরিগুলো বের করা
    const categories = ['ALL', ...new Set(channels.map(channel => channel.category).filter(Boolean))];

    // ক্যাটাগরি বাটনগুলো তৈরি করা
    categoryBar.innerHTML = categories.map(cat => `
        <button class="category-btn whitespace-nowrap px-4 py-2 text-sm font-semibold rounded-full transition-colors duration-200" data-category="${cat}">
            ${cat}
        </button>
    `).join('');

    // চ্যানেল কার্ডগুলো তৈরি করা এবং গ্রিডে যোগ করা
    gridContainer.innerHTML = channels.map(channel => {
        const cardHTML = Render.liveTvChannelCard(channel, true);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = cardHTML;
        const cardElement = wrapper.firstChild;
        cardElement.dataset.channelCategory = channel.category || '';
        return cardElement.outerHTML;
    }).join('');
    
    const categoryButtons = categoryBar.querySelectorAll('.category-btn');
    const channelCards = gridContainer.querySelectorAll('[data-channel-category]');

    // ফিল্টারিং ফাংশন
    function filterChannels(category) {
        categoryButtons.forEach(btn => {
            if (btn.dataset.category === category) {
                btn.style.backgroundColor = 'var(--primary-color)';
                btn.style.color = 'white';
            } else {
                btn.style.backgroundColor = '#2a2a2a';
                btn.style.color = '#d1d5db';
            }
        });

        channelCards.forEach(card => {
            if (category === 'ALL' || card.dataset.channelCategory === category) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // বাটনগুলোতে ক্লিক ইভেন্ট যোগ করা
    categoryBar.addEventListener('click', (e) => {
        const button = e.target.closest('.category-btn');
        if (button) {
            const selectedCategory = button.dataset.category;
            filterChannels(selectedCategory);
        }
    });

    // প্রথমবার লোড হওয়ার সময় "ALL" ক্যাটাগরিটি ডিফল্ট হিসেবে সেট করা
    filterChannels('ALL');
},
    init() { Drawer.init(); App.switchPage('home-page'); this.setupEventListeners(); this.fetchAllContent(); this.renderTopSearches(); }
};

App.init();

(function () {
  const ua=navigator.userAgent.toLowerCase();if(["smart-tv","smarttv","tizen","webos","hbbtv","netcast","viera","appletv","crkey","bravia","philips","hisense","roku","aftt","aftb","aftm","firetv","android tv","googletv","lgtv","samsungtv","sonytv"].some(k=>ua.includes(k))||(!/android|iphone|ipad|ipod|kindle|silk|opera mini|mobile/.test(ua)&&(/(windows nt|macintosh|x11|linux x86_64|cros)/.test(ua)||(Math.max(screen.width,screen.height)>=1024&&!('ontouchstart' in window))))){window.location.href="go:smarttv"}
})();
</script>

</body>
</html>
